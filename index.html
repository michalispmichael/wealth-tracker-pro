<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Professional wealth tracking and financial management PWA">
    <title>WealthTracker Pro</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    
    <!-- Stylesheets -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        .chart-container {
            position: relative;
            height: 300px;
            padding: 10px;
        }
        
        .chart-container canvas {
            max-height: 280px !important;
        }
        
        .sidebar-transition {
            transition: all 0.3s ease-in-out;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .nav-item {
            transition: all 0.2s ease;
        }
        
        .nav-item:hover {
            transform: translateX(4px);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .progress-bar {
            transition: width 0.8s ease-in-out;
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ef4444;
            color: white;
            text-align: center;
            padding: 8px;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .offline-banner.show {
            transform: translateY(0);
        }

        .risk-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .risk-low { color: #10B981; }
        .risk-medium { color: #F59E0B; }
        .risk-high { color: #EF4444; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="loading-spinner border-4 border-blue-200 border-t-blue-600 rounded-full w-12 h-12 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading WealthTracker...</p>
        </div>
    </div>
    
    <!-- Offline Banner -->
    <div id="offlineBanner" class="offline-banner">
        <span>‚ö†Ô∏è You're offline. Changes will sync when connection is restored.</span>
    </div>

    <!-- Install Prompt -->
    <div id="installPrompt" class="hidden fixed bottom-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg z-50">
        <div class="flex items-center space-x-3">
            <div>
                <p class="font-medium">Install WealthTracker</p>
                <p class="text-sm opacity-90">Add to home screen for easier access</p>
            </div>
            <div class="flex space-x-2">
                <button id="installCancel" class="px-3 py-1 bg-blue-500 rounded text-sm">Later</button>
                <button id="installAccept" class="px-3 py-1 bg-white text-blue-600 rounded text-sm font-medium">Install</button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-xl sidebar-transition" id="sidebar">
        <div class="flex h-full flex-col">
            <!-- Logo -->
            <div class="flex h-16 items-center justify-center px-6 gradient-bg">
                <div class="flex items-center space-x-3">
                    <div class="p-2 bg-white/20 rounded-lg">
                        <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                    </div>
                    <span class="text-xl font-bold text-white">WealthTracker Pro</span>
                </div>
            </div>

            <!-- Language & Currency -->
            <div class="px-4 py-3 bg-gray-50 border-b">
                <div class="flex items-center justify-between mb-2">
                    <select id="languageSelect" class="text-sm border border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="en">English</option>
                        <option value="el">ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨</option>
                    </select>
                    <select id="currencySelect" class="text-sm border border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="EUR">EUR (‚Ç¨)</option>
                        <option value="USD">USD ($)</option>
                        <option value="GBP">GBP (¬£)</option>
                    </select>
                </div>
                <div class="text-xs text-gray-500 flex items-center">
                    <div id="syncStatus" class="flex items-center">
                        <div id="syncIcon" class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                        <span id="syncText">Synced</span>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 px-4 py-4 space-y-2">
                <button data-tab="dashboard" class="nav-item active w-full flex items-center space-x-3 px-3 py-2 text-sm font-medium rounded-lg">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span data-translate="dashboard">Dashboard</span>
                </button>
                <button data-tab="assets" class="nav-item w-full flex items-center space-x-3 px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50">
                    <i data-lucide="trending-up" class="w-5 h-5"></i>
                    <span data-translate="assets">Assets</span>
                </button>
                <button data-tab="capital-markets" class="nav-item w-full flex items-center space-x-3 px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                    <span data-translate="capital_markets">Capital Markets</span>
                </button>
                <button data-tab="real-estate" class="nav-item w-full flex items-center space-x-3 px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    <span data-translate="real_estate">Real Estate</span>
                </button>
                <button data-tab="accounts" class="nav-item w-full flex items-center space-x-3 px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50">
                    <i data-lucide="credit-card" class="w-5 h-5"></i>
                    <span data-translate="accounts">Accounts</span>
                </button>
                <button data-tab="liabilities" class="nav-item w-full flex items-center space-x-3 px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50">
                    <i data-lucide="minus-circle" class="w-5 h-5"></i>
                    <span data-translate="liabilities">Liabilities</span>
                </button>
                <button data-tab="income" class="nav-item w-full flex items-center space-x-3 px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50">
                    <i data-lucide="dollar-sign" class="w-5 h-5"></i>
                    <span data-translate="income">Income</span>
                </button>
                <button data-tab="expenses" class="nav-item w-full flex items-center space-x-3 px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50">
                    <i data-lucide="receipt" class="w-5 h-5"></i>
                    <span data-translate="expenses">Expenses</span>
                </button>
                <button data-tab="budgets" class="nav-item w-full flex items-center space-x-3 px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50">
                    <i data-lucide="target" class="w-5 h-5"></i>
                    <span data-translate="budgets">Budgets</span>
                </button>
                <button data-tab="analytics" class="nav-item w-full flex items-center space-x-3 px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50">
                    <i data-lucide="pie-chart" class="w-5 h-5"></i>
                    <span data-translate="analytics">Analytics</span>
                </button>
            </nav>

            <!-- Export Button -->
            <div class="p-4 border-t">
                <button id="exportBtn" class="w-full flex items-center justify-center space-x-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    <span data-translate="export">Export</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="ml-64 min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-40">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900" id="pageTitle" data-translate="dashboard">Dashboard</h1>
                        <p class="text-sm text-gray-500" data-translate="welcome_message">Welcome to your financial overview</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="addItemBtn" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span data-translate="add_item">Add Item</span>
                        </button>
                        <div class="text-sm text-gray-500">
                            <span data-translate="last_updated">Last Updated:</span> <span id="lastUpdated"></span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <main class="p-6">
            <!-- Dashboard Tab -->
            <div id="dashboard-content" class="tab-content fade-in">
                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                    <div class="stat-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500" data-translate="net_worth">Net Worth</p>
                                <p class="text-2xl font-bold text-gray-900" id="netWorthValue">‚Ç¨0</p>
                                <p class="text-sm text-green-600 mt-1 flex items-center">
                                    <i data-lucide="trending-up" class="w-3 h-3 mr-1"></i>
                                    <span data-translate="total_wealth">Total Wealth</span>
                                </p>
                            </div>
                            <div class="p-3 bg-blue-50 rounded-xl">
                                <i data-lucide="trending-up" class="w-6 h-6 text-blue-600"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500" data-translate="total_assets">Total Assets</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalAssetsValue">‚Ç¨0</p>
                                <p class="text-sm text-gray-500 mt-1" data-translate="all_holdings">All Holdings</p>
                            </div>
                            <div class="p-3 bg-green-50 rounded-xl">
                                <i data-lucide="arrow-up-right" class="w-6 h-6 text-green-600"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500" data-translate="invested_capital">Invested Capital</p>
                                <p class="text-2xl font-bold text-gray-900" id="investedCapitalValue">‚Ç¨0</p>
                                <p class="text-sm text-blue-600 mt-1" data-translate="growing_assets">Growing Assets</p>
                            </div>
                            <div class="p-3 bg-purple-50 rounded-xl">
                                <i data-lucide="line-chart" class="w-6 h-6 text-purple-600"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500" data-translate="monthly_income">Monthly Income</p>
                                <p class="text-2xl font-bold text-gray-900" id="monthlyIncomeValue">‚Ç¨0</p>
                                <p class="text-sm text-gray-500 mt-1" data-translate="after_taxes">After Taxes</p>
                            </div>
                            <div class="p-3 bg-indigo-50 rounded-xl">
                                <i data-lucide="dollar-sign" class="w-6 h-6 text-indigo-600"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500" data-translate="monthly_expenses">Monthly Expenses</p>
                                <p class="text-2xl font-bold text-gray-900" id="monthlyExpensesValue">‚Ç¨0</p>
                                <p class="text-sm text-red-600 mt-1" data-translate="this_month">This Month</p>
                            </div>
                            <div class="p-3 bg-red-50 rounded-xl">
                                <i data-lucide="arrow-down-right" class="w-6 h-6 text-red-600"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="asset_allocation">Asset Allocation</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="assetAllocationChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="net_worth_trend">Net Worth Trend</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="netWorthChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="recent_transactions">Recent Transactions</h3>
                        </div>
                        <div class="p-6">
                            <div id="recentTransactions" class="space-y-4">
                                <!-- Transactions will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="budget_overview">Budget Overview</h3>
                        </div>
                        <div class="p-6">
                            <div id="budgetOverview" class="space-y-4">
                                <!-- Budget overview will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assets Tab -->
            <div id="assets-content" class="tab-content hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-gray-900" data-translate="asset_breakdown">Asset Breakdown</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="assetBreakdownChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4" data-translate="asset_summary">Asset Summary</h3>
                            <div id="assetSummary" class="space-y-4">
                                <!-- Asset summary will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Capital Markets Tab -->
            <div id="capital-markets-content" class="tab-content hidden fade-in">
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="capital_markets_portfolio">Capital Markets Portfolio</h3>
                            <button id="addCapitalMarketBtn" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                <span data-translate="add_investment">Add Investment</span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="investment">Investment</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="type">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="monthly_investment">Monthly Investment</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="risk_level">Risk Level</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="current_value">Current Value</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="gain_loss">Gain/Loss</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="capitalMarketsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Investment rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real Estate Tab -->
            <div id="real-estate-content" class="tab-content hidden fade-in">
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="real_estate_portfolio">Real Estate Portfolio</h3>
                            <button id="addPropertyBtn" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                <span data-translate="add_property">Add Property</span>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6" id="propertiesGrid">
                            <!-- Property cards will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accounts Tab -->
            <div id="accounts-content" class="tab-content hidden fade-in">
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="bank_accounts">Bank Accounts</h3>
                            <button id="addAccountBtn" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                <span data-translate="add_account">Add Account</span>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6" id="accountsGrid">
                            <!-- Account cards will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Liabilities Tab -->
            <div id="liabilities-content" class="tab-content hidden fade-in">
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="liabilities_debts">Liabilities & Debts</h3>
                            <button id="addLiabilityBtn" class="flex items-center space-x-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                <span data-translate="add_liability">Add Liability</span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="liability">Liability</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="type">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="balance">Balance</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="interest_rate">Interest Rate</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="monthly_payment">Monthly Payment</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="liabilitiesTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Liability rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Income Tab -->
            <div id="income-content" class="tab-content hidden fade-in">
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="income_sources">Income Sources</h3>
                            <button id="addIncomeBtn" class="flex items-center space-x-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                <span data-translate="add_income">Add Income</span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="source">Source</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="type">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="monthly_gross">Monthly Gross</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="monthly_net">Monthly Net</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="annual_net">Annual Net</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="incomeTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Income rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expenses-content" class="tab-content hidden fade-in">
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="expense_tracking">Expense Tracking</h3>
                            <button id="addExpenseBtn" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                <span data-translate="add_expense">Add Expense</span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="date">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="description">Description</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="category">Category</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="amount">Amount</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expensesTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Expense rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budgets Tab -->
            <div id="budgets-content" class="tab-content hidden fade-in">
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="monthly_budgets">Monthly Budgets</h3>
                            <button id="addBudgetBtn" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                <span data-translate="add_budget">Add Budget</span>
                            </button>
                        </div>
                        <div class="p-6">
                            <div id="budgetsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <!-- Budget cards will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-content" class="tab-content hidden fade-in">
                <div class="space-y-6">
                    <!-- Investment Risk Overview -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="investment_risk_overview">Investment Risk Overview</h3>
                        </div>
                        <div class="p-6">
                            <div id="investmentRiskMetrics" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <!-- Risk metrics will be populated here -->
                            </div>
                            <div class="chart-container">
                                <canvas id="riskAllocationChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-900" data-translate="expense_breakdown">Expense Breakdown</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="expenseBreakdownChart"></canvas>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-900" data-translate="income_vs_expenses">Income vs Expenses</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="incomeVsExpensesChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="financial_health">Financial Health</h3>
                        </div>
                        <div class="p-6">
                            <div id="financialHealthMetrics" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Financial health metrics will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Universal Add Modal -->
    <div id="addModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900" id="modalTitle">Add Item</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div id="modalForm" class="space-y-4">
                    <!-- Form fields will be populated dynamically -->
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-200 flex space-x-3">
                <button id="cancelModal" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors" data-translate="cancel">Cancel</button>
                <button id="saveModal" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors" data-translate="save">Save</button>
            </div>
        </div>
    </div>

    <script>
        // üî• FIREBASE CONFIGURATION - KEEP YOUR EXISTING CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDOi3pkTY7Nof19auZkLzs4KnhJ8DTPqwI",
            authDomain: "wealth-tracker-app-4209f.firebaseapp.com",
            projectId: "wealth-tracker-app-4209f",
            storageBucket: "wealth-tracker-app-4209f.firebasestorage.app",
            messagingSenderId: "797179155261",
            appId: "1:797179155261:web:f63fc53f42029743c7ab54",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // üåç GLOBAL STATE
        let currentLanguage = 'en';
        let currentCurrency = 'EUR';
        let activeTab = 'dashboard';
        let currentModalType = '';
        let editingId = null;
        let isOnline = navigator.onLine;
        let syncInProgress = false;

        // üìä DATA ARRAYS (Now will sync with Firebase)
        let capitalMarkets = []; // Renamed from investments
        let properties = [];
        let accounts = [];
        let liabilities = [];
        let incomes = [];
        let expenses = [];
        let budgets = [];
        let otherAssets = [];

        // üîÑ FIREBASE FUNCTIONS
        class FirebaseService {
            static async saveData(collection, data) {
                try {
                    if (data.id && typeof data.id === 'string') {
                        // Update existing document
                        await db.collection(collection).doc(data.id).set(data);
                    } else {
                        // Create new document
                        const docRef = await db.collection(collection).add(data);
                        data.id = docRef.id;
                    }
                    this.updateSyncStatus('success');
                    return data;
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                    this.updateSyncStatus('error');
                    throw error;
                }
            }

            static async loadData(collection) {
                try {
                    this.updateSyncStatus('syncing');
                    const snapshot = await db.collection(collection).get();
                    const data = [];
                    snapshot.forEach(doc => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    this.updateSyncStatus('success');
                    return data;
                } catch (error) {
                    console.error('Error loading from Firebase:', error);
                    this.updateSyncStatus('error');
                    return [];
                }
            }

            static async deleteData(collection, id) {
                try {
                    await db.collection(collection).doc(id).delete();
                    this.updateSyncStatus('success');
                } catch (error) {
                    console.error('Error deleting from Firebase:', error);
                    this.updateSyncStatus('error');
                    throw error;
                }
            }

            static updateSyncStatus(status) {
                const syncIcon = document.getElementById('syncIcon');
                const syncText = document.getElementById('syncText');
                
                if (!syncIcon || !syncText) return;

                switch (status) {
                    case 'syncing':
                        syncIcon.className = 'w-3 h-3 rounded-full bg-yellow-500 mr-2 loading-spinner';
                        syncText.textContent = 'Syncing...';
                        break;
                    case 'success':
                        syncIcon.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                        syncText.textContent = 'Synced';
                        break;
                    case 'error':
                        syncIcon.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                        syncText.textContent = 'Sync Error';
                        break;
                    case 'offline':
                        syncIcon.className = 'w-3 h-3 rounded-full bg-gray-500 mr-2';
                        syncText.textContent = 'Offline';
                        break;
                }
            }

            static async initializeData() {
                try {
                    // Load all data from Firebase (using new collection names)
                    const [
                        capitalMarketsData,
                        propertiesData,
                        accountsData,
                        liabilitiesData,
                        incomesData,
                        expensesData,
                        budgetsData,
                        otherAssetsData
                    ] = await Promise.all([
                        this.loadData('capitalMarkets'), // Changed from 'investments'
                        this.loadData('properties'),
                        this.loadData('accounts'),
                        this.loadData('liabilities'),
                        this.loadData('incomes'),
                        this.loadData('expenses'),
                        this.loadData('budgets'),
                        this.loadData('otherAssets')
                    ]);

                    // Update global arrays
                    capitalMarkets = capitalMarketsData;
                    properties = propertiesData;
                    accounts = accountsData;
                    liabilities = liabilitiesData;
                    incomes = incomesData;
                    expenses = expensesData;
                    budgets = budgetsData;
                    otherAssets = otherAssetsData;

                    // If no data exists, populate with sample data
                    if (capitalMarkets.length === 0 && properties.length === 0 && accounts.length === 0) {
                        await this.createSampleData();
                    }

                } catch (error) {
                    console.error('Error initializing data:', error);
                    // Load sample data offline
                    this.loadSampleData();
                }
            }

            static async createSampleData() {
                // Sample capital markets investments
                const sampleCapitalMarkets = [
                    { 
                        name: 'Apple Inc. (AAPL)', 
                        type: 'stocks', 
                        quantity: 50, 
                        purchasePrice: 127.50, 
                        currentPrice: 157.50, 
                        monthlyInvestment: 500,
                        riskLevel: 'medium',
                        currency: 'USD' 
                    },
                    { 
                        name: 'Bitcoin', 
                        type: 'cryptocurrency', 
                        quantity: 0.5, 
                        purchasePrice: 45000, 
                        currentPrice: 52000, 
                        monthlyInvestment: 300,
                        riskLevel: 'high',
                        currency: 'USD' 
                    },
                    { 
                        name: 'Vanguard S&P 500 ETF', 
                        type: 'etf', 
                        quantity: 100, 
                        purchasePrice: 380, 
                        currentPrice: 420, 
                        monthlyInvestment: 600,
                        riskLevel: 'medium',
                        currency: 'USD' 
                    },
                    { 
                        name: 'Life Insurance Policy', 
                        type: 'life_insurance', 
                        quantity: 1, 
                        purchasePrice: 25000, 
                        currentValue: 27000, 
                        monthlyInvestment: 150,
                        riskLevel: 'low',
                        currency: 'EUR' 
                    }
                ];

                // Sample properties
                const sampleProperties = [
                    { name: 'Main Residence', address: '123 Main St, Athens', purchasePrice: 300000, currentValue: 375000, type: 'residential', currency: 'EUR' },
                    { name: 'Rental Property', address: '456 Oak Ave, Thessaloniki', purchasePrice: 150000, currentValue: 180000, type: 'rental', monthlyRent: 800, currency: 'EUR' }
                ];

                // Sample accounts with enhanced features
                const sampleAccounts = [
                    { 
                        name: 'Alpha Bank Checking', 
                        bank: 'Alpha Bank', 
                        balance: 8500, 
                        type: 'checking', 
                        currency: 'EUR',
                        terms: 'No minimum balance, monthly fee ‚Ç¨5',
                        interestRate: 0,
                        lockupPeriod: 0
                    },
                    { 
                        name: 'Eurobank Savings', 
                        bank: 'Eurobank', 
                        balance: 25000, 
                        type: 'savings', 
                        currency: 'EUR',
                        terms: 'Minimum balance ‚Ç¨1000, no fees',
                        interestRate: 1.5,
                        lockupPeriod: 0
                    },
                    { 
                        name: 'Piraeus Term Deposit', 
                        bank: 'Piraeus Bank', 
                        balance: 50000, 
                        type: 'term_deposit', 
                        currency: 'EUR',
                        terms: '12-month term deposit',
                        interestRate: 3.2,
                        lockupPeriod: 12
                    }
                ];

                // Rest of sample data remains the same...
                const sampleLiabilities = [
                    { name: 'Home Mortgage', type: 'mortgage', balance: 195000, interestRate: 2.5, monthlyPayment: 950, currency: 'EUR' },
                    { name: 'Car Loan', type: 'car_loan', balance: 15000, interestRate: 4.2, monthlyPayment: 320, currency: 'EUR' }
                ];

                const sampleIncomes = [
                    { name: 'Primary Salary', type: 'salary', monthlyGross: 4500, taxRate: 35, employer: 'Tech Company Ltd', currency: 'EUR' },
                    { name: 'Rental Income', type: 'rental', monthlyGross: 800, taxRate: 15, employer: 'Rental Property', currency: 'EUR' },
                    { name: 'Freelance Work', type: 'freelance', monthlyGross: 1200, taxRate: 20, employer: 'Various Clients', currency: 'EUR' }
                ];

                const sampleExpenses = [
                    { date: '2025-01-10', description: 'Supermarket Shopping', category: 'groceries', amount: 125.50, currency: 'EUR' },
                    { date: '2025-01-09', description: 'Gasoline', category: 'transportation', amount: 65.00, currency: 'EUR' },
                    { date: '2025-01-08', description: 'Restaurant Dinner', category: 'dining', amount: 85.00, currency: 'EUR' }
                ];

                const sampleBudgets = [
                    { category: 'groceries', amount: 600, spent: 425.50, currency: 'EUR' },
                    { category: 'transportation', amount: 400, spent: 285.00, currency: 'EUR' },
                    { category: 'dining', amount: 300, spent: 185.50, currency: 'EUR' }
                ];

                const sampleOtherAssets = [
                    { name: 'Car - BMW 3 Series', type: 'vehicle', value: 35000, currency: 'EUR' },
                    { name: 'Jewelry Collection', type: 'jewelry', value: 8000, currency: 'EUR' }
                ];
                
                try {
                    for (const investment of sampleCapitalMarkets) {
                        await this.saveData('capitalMarkets', investment);
                        capitalMarkets.push(investment);
                    }

                    for (const property of sampleProperties) {
                        await this.saveData('properties', property);
                        properties.push(property);
                    }

                    for (const account of sampleAccounts) {
                        await this.saveData('accounts', account);
                        accounts.push(account);
                    }

                    for (const liability of sampleLiabilities) {
                        await this.saveData('liabilities', liability);
                        liabilities.push(liability);
                    }

                    for (const income of sampleIncomes) {
                        await this.saveData('incomes', income);
                        incomes.push(income);
                    }

                    for (const expense of sampleExpenses) {
                        await this.saveData('expenses', expense);
                        expenses.push(expense);
                    }

                    for (const budget of sampleBudgets) {
                        await this.saveData('budgets', budget);
                        budgets.push(budget);
                    }

                    for (const asset of sampleOtherAssets) {
                        await this.saveData('otherAssets', asset);
                        otherAssets.push(asset);
                    }

                } catch (error) {
                    console.error('Error creating sample data:', error);
                }
            }

            static loadSampleData() {
                // Fallback sample data for offline use
                capitalMarkets = [
                    { id: 'sample1', name: 'Apple Inc. (AAPL)', type: 'stocks', quantity: 50, purchasePrice: 127.50, currentPrice: 157.50, monthlyInvestment: 500, riskLevel: 'medium', currency: 'USD' },
                    { id: 'sample2', name: 'Bitcoin', type: 'cryptocurrency', quantity: 0.5, purchasePrice: 45000, currentPrice: 52000, monthlyInvestment: 300, riskLevel: 'high', currency: 'USD' }
                ];
                
                properties = [
                    { id: 'prop1', name: 'Main Residence', address: '123 Main St, Athens', purchasePrice: 300000, currentValue: 375000, type: 'residential', currency: 'EUR' }
                ];

                accounts = [
                    { id: 'acc1', name: 'Alpha Bank Checking', bank: 'Alpha Bank', balance: 8500, type: 'checking', currency: 'EUR', terms: 'Standard checking account', interestRate: 0, lockupPeriod: 0 }
                ];

                liabilities = [
                    { id: 'lib1', name: 'Home Mortgage', type: 'mortgage', balance: 195000, interestRate: 2.5, monthlyPayment: 950, currency: 'EUR' }
                ];

                incomes = [
                    { id: 'inc1', name: 'Primary Salary', type: 'salary', monthlyGross: 4500, taxRate: 35, employer: 'Tech Company Ltd', currency: 'EUR' }
                ];

                expenses = [
                    { id: 'exp1', date: '2025-01-10', description: 'Supermarket Shopping', category: 'groceries', amount: 125.50, currency: 'EUR' }
                ];

                budgets = [
                    { id: 'bud1', category: 'groceries', amount: 600, spent: 425.50, currency: 'EUR' }
                ];

                otherAssets = [
                    { id: 'other1', name: 'Car', type: 'vehicle', value: 25000, currency: 'EUR' }
                ];
            }
        }

        // üîÑ PWA FUNCTIONS
        class PWAService {
            static init() {
                // Register service worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(registration => {
                            console.log('Service Worker registered:', registration);
                        })
                        .catch(error => {
                            console.log('Service Worker registration failed:', error);
                        });
                }

                // Handle app install
                this.handleInstallPrompt();

                // Handle online/offline status
                this.handleConnectionStatus();
            }

            static handleInstallPrompt() {
                let deferredPrompt;
                const installPrompt = document.getElementById('installPrompt');
                const installAccept = document.getElementById('installAccept');
                const installCancel = document.getElementById('installCancel');

                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    installPrompt.classList.remove('hidden');
                });

                if (installAccept) {
                    installAccept.addEventListener('click', async () => {
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            const { outcome } = await deferredPrompt.userChoice;
                            console.log(`User response to install prompt: ${outcome}`);
                            deferredPrompt = null;
                        }
                        installPrompt.classList.add('hidden');
                    });
                }

                if (installCancel) {
                    installCancel.addEventListener('click', () => {
                        installPrompt.classList.add('hidden');
                    });
                }
            }

            static handleConnectionStatus() {
                const offlineBanner = document.getElementById('offlineBanner');

                function updateOnlineStatus() {
                    isOnline = navigator.onLine;
                    
                    if (isOnline) {
                        offlineBanner.classList.remove('show');
                        FirebaseService.updateSyncStatus('success');
                    } else {
                        offlineBanner.classList.add('show');
                        FirebaseService.updateSyncStatus('offline');
                    }
                }

                window.addEventListener('online', updateOnlineStatus);
                window.addEventListener('offline', updateOnlineStatus);
                
                // Initial check
                updateOnlineStatus();
            }
        }

        // Enhanced Translation object with new terms
        const translations = {
            en: {
                dashboard: 'Dashboard',
                assets: 'Assets',
                capital_markets: 'Capital Markets',
                real_estate: 'Real Estate',
                accounts: 'Accounts',
                liabilities: 'Liabilities',
                income: 'Income',
                expenses: 'Expenses',
                budgets: 'Budgets',
                analytics: 'Analytics',
                export: 'Export',
                welcome_message: 'Welcome to your financial overview',
                add_item: 'Add Item',
                last_updated: 'Last Updated',
                net_worth: 'Net Worth',
                total_wealth: 'Total Wealth',
                total_assets: 'Total Assets',
                all_holdings: 'All Holdings',
                invested_capital: 'Invested Capital',
                growing_assets: 'Growing Assets',
                monthly_income: 'Monthly Income',
                after_taxes: 'After Taxes',
                monthly_expenses: 'Monthly Expenses',
                this_month: 'This Month',
                asset_allocation: 'Asset Allocation',
                net_worth_trend: 'Net Worth Trend',
                recent_transactions: 'Recent Transactions',
                budget_overview: 'Budget Overview',
                asset_breakdown: 'Asset Breakdown',
                asset_summary: 'Asset Summary',
                capital_markets_portfolio: 'Capital Markets Portfolio',
                add_investment: 'Add Investment',
                investment: 'Investment',
                type: 'Type',
                quantity: 'Quantity',
                purchase_price: 'Purchase Price',
                current_price: 'Current Price',
                current_value: 'Current Value',
                total_value: 'Total Value',
                gain_loss: 'Gain/Loss',
                monthly_investment: 'Monthly Investment',
                risk_level: 'Risk Level',
                investment_risk_overview: 'Investment Risk Overview',
                actions: 'Actions',
                real_estate_portfolio: 'Real Estate Portfolio',
                add_property: 'Add Property',
                bank_accounts: 'Bank Accounts',
                add_account: 'Add Account',
                account_terms: 'Account Terms',
                interest_rate: 'Interest Rate',
                lockup_period: 'Lockup Period (months)',
                liabilities_debts: 'Liabilities & Debts',
                add_liability: 'Add Liability',
                liability: 'Liability',
                balance: 'Balance',
                monthly_payment: 'Monthly Payment',
                income_sources: 'Income Sources',
                add_income: 'Add Income',
                source: 'Source',
                monthly_gross: 'Monthly Gross',
                monthly_net: 'Monthly Net',
                annual_net: 'Annual Net',
                expense_tracking: 'Expense Tracking',
                add_expense: 'Add Expense',
                date: 'Date',
                description: 'Description',
                category: 'Category',
                amount: 'Amount',
                monthly_budgets: 'Monthly Budgets',
                add_budget: 'Add Budget',
                expense_breakdown: 'Expense Breakdown',
                income_vs_expenses: 'Income vs Expenses',
                financial_health: 'Financial Health',
                cancel: 'Cancel',
                save: 'Save',
                name: 'Name',
                address: 'Address',
                bank: 'Bank',
                employer: 'Employer',
                tax_rate: 'Tax Rate (%)',
                monthly_rent: 'Monthly Rent',
                purchase_date: 'Purchase Date',
                budget_limit: 'Budget Limit',
                spent_amount: 'Spent Amount',
                remaining: 'Remaining',
                over_budget: 'Over Budget',
                debt_to_asset_ratio: 'Debt-to-Asset Ratio',
                debt_to_income_ratio: 'Debt-to-Income Ratio',
                savings_rate: 'Savings Rate',
                emergency_fund: 'Emergency Fund',
                months_of_expenses: 'Months of Expenses Covered',
                // Asset Types
                stocks: 'Stocks',
                bonds: 'Bonds',
                etf: 'ETF',
                mutual_fund: 'Mutual Fund',
                cryptocurrency: 'Cryptocurrency',
                index_fund: 'Index Fund',
                life_insurance: 'Life Insurance',
                vehicle: 'Vehicle',
                jewelry: 'Jewelry',
                // Risk Levels
                low: 'Low',
                medium: 'Medium',
                high: 'High',
                // Property Types
                residential: 'Residential',
                rental: 'Rental',
                commercial: 'Commercial',
                // Account Types
                checking: 'Checking',
                savings: 'Savings',
                term_deposit: 'Term Deposit',
                // Liability Types
                mortgage: 'Mortgage',
                car_loan: 'Car Loan',
                personal_loan: 'Personal Loan',
                credit_card: 'Credit Card',
                student_loan: 'Student Loan',
                // Income Types
                salary: 'Salary',
                freelance: 'Freelance',
                business: 'Business',
                rental: 'Rental',
                dividends: 'Dividends',
                pension: 'Pension',
                // Expense Categories
                groceries: 'Groceries',
                transportation: 'Transportation',
                dining: 'Dining',
                utilities: 'Utilities',
                entertainment: 'Entertainment',
                health: 'Health',
                shopping: 'Shopping',
                travel: 'Travel',
                education: 'Education',
                insurance: 'Insurance',
                other: 'Other'
            },
            el: {
                dashboard: 'Œ†ŒØŒΩŒ±Œ∫Œ±œÇ ŒïŒªŒ≠Œ≥œáŒøœÖ',
                assets: 'Œ†ŒµœÅŒπŒøœÖœÉŒπŒ±Œ∫Œ¨ Œ£œÑŒøŒπœáŒµŒØŒ±',
                capital_markets: 'ŒöŒµœÜŒ±ŒªŒ±ŒπŒ±Œ≥ŒøœÅŒ¨',
                real_estate: 'ŒëŒ∫ŒØŒΩŒ∑œÑŒ±',
                accounts: 'ŒõŒøŒ≥Œ±œÅŒπŒ±œÉŒºŒøŒØ',
                liabilities: 'Œ•œÄŒøœáœÅŒµœéœÉŒµŒπœÇ',
                income: 'ŒïŒπœÉœåŒ¥Œ∑ŒºŒ±',
                expenses: 'ŒàŒæŒøŒ¥Œ±',
                budgets: 'Œ†œÅŒøœãœÄŒøŒªŒøŒ≥ŒπœÉŒºŒøŒØ',
                analytics: 'ŒëŒΩŒ±ŒªœÖœÑŒπŒ∫Œ¨',
                export: 'ŒïŒæŒ±Œ≥œâŒ≥ŒÆ',
                welcome_message: 'ŒöŒ±ŒªœéœÇ ŒÆœÅŒ∏Œ±œÑŒµ œÉœÑŒ∑ŒΩ ŒøŒπŒ∫ŒøŒΩŒøŒºŒπŒ∫ŒÆ œÉŒ±œÇ ŒµœÄŒπœÉŒ∫œåœÄŒ∑œÉŒ∑',
                add_item: 'Œ†œÅŒøœÉŒ∏ŒÆŒ∫Œ∑ Œ£œÑŒøŒπœáŒµŒØŒøœÖ',
                last_updated: 'Œ§ŒµŒªŒµœÖœÑŒ±ŒØŒ± ŒïŒΩŒ∑ŒºŒ≠œÅœâœÉŒ∑',
                net_worth: 'ŒöŒ±Œ∏Œ±œÅŒÆ ŒëŒæŒØŒ±',
                total_wealth: 'Œ£œÖŒΩŒøŒªŒπŒ∫œåœÇ Œ†ŒªŒøœçœÑŒøœÇ',
                total_assets: 'Œ£œÖŒΩŒøŒªŒπŒ∫Œ¨ Œ†ŒµœÅŒπŒøœÖœÉŒπŒ±Œ∫Œ¨',
                all_holdings: 'ŒåŒªŒµœÇ ŒøŒπ Œ£œÖŒºŒºŒµœÑŒøœáŒ≠œÇ',
                invested_capital: 'ŒïœÄŒµŒΩŒ¥œÖŒºŒ≠ŒΩŒø ŒöŒµœÜŒ¨ŒªŒ±ŒπŒø',
                growing_assets: 'ŒëœÖŒæŒ±ŒΩœåŒºŒµŒΩŒ± Œ†ŒµœÅŒπŒøœÖœÉŒπŒ±Œ∫Œ¨',
                monthly_income: 'ŒúŒ∑ŒΩŒπŒ±ŒØŒø ŒïŒπœÉœåŒ¥Œ∑ŒºŒ±',
                after_taxes: 'ŒúŒµœÑŒ¨ Œ±œÄœå Œ¶œåœÅŒøœÖœÇ',
                monthly_expenses: 'ŒúŒ∑ŒΩŒπŒ±ŒØŒ± ŒàŒæŒøŒ¥Œ±',
                this_month: 'Œ§ŒøŒΩ ŒúŒÆŒΩŒ±',
                asset_allocation: 'ŒöŒ±œÑŒ±ŒΩŒøŒºŒÆ Œ†ŒµœÅŒπŒøœÖœÉŒØŒ±œÇ',
                net_worth_trend: 'Œ§Œ¨œÉŒ∑ ŒöŒ±Œ∏Œ±œÅŒÆœÇ ŒëŒæŒØŒ±œÇ',
                recent_transactions: 'Œ†œÅœåœÉœÜŒ±œÑŒµœÇ Œ£œÖŒΩŒ±ŒªŒªŒ±Œ≥Œ≠œÇ',
                budget_overview: 'ŒïœÄŒπœÉŒ∫œåœÄŒ∑œÉŒ∑ Œ†œÅŒøœãœÄŒøŒªŒøŒ≥ŒπœÉŒºŒøœç',
                asset_breakdown: 'ŒëŒΩŒ¨ŒªœÖœÉŒ∑ Œ†ŒµœÅŒπŒøœÖœÉŒØŒ±œÇ',
                asset_summary: 'Œ†ŒµœÅŒØŒªŒ∑œàŒ∑ Œ†ŒµœÅŒπŒøœÖœÉŒØŒ±œÇ',
                capital_markets_portfolio: 'ŒßŒ±œÅœÑŒøœÜœÖŒªŒ¨Œ∫ŒπŒø ŒöŒµœÜŒ±ŒªŒ±ŒπŒ±Œ≥ŒøœÅŒ¨œÇ',
                add_investment: 'Œ†œÅŒøœÉŒ∏ŒÆŒ∫Œ∑ ŒïœÄŒ≠ŒΩŒ¥œÖœÉŒ∑œÇ',
                investment: 'ŒïœÄŒ≠ŒΩŒ¥œÖœÉŒ∑',
                type: 'Œ§œçœÄŒøœÇ',
                quantity: 'Œ†ŒøœÉœåœÑŒ∑œÑŒ±',
                purchase_price: 'Œ§ŒπŒºŒÆ ŒëŒ≥ŒøœÅŒ¨œÇ',
                current_price: 'Œ§œÅŒ≠œáŒøœÖœÉŒ± Œ§ŒπŒºŒÆ',
                current_value: 'Œ§œÅŒ≠œáŒøœÖœÉŒ± ŒëŒæŒØŒ±',
                total_value: 'Œ£œÖŒΩŒøŒªŒπŒ∫ŒÆ ŒëŒæŒØŒ±',
                gain_loss: 'ŒöŒ≠œÅŒ¥ŒøœÇ/ŒñŒ∑ŒºŒØŒ±',
                monthly_investment: 'ŒúŒ∑ŒΩŒπŒ±ŒØŒ± ŒïœÄŒ≠ŒΩŒ¥œÖœÉŒ∑',
                risk_level: 'ŒïœÄŒØœÄŒµŒ¥Œø Œ°ŒØœÉŒ∫ŒøœÖ',
                investment_risk_overview: 'ŒïœÄŒπœÉŒ∫œåœÄŒ∑œÉŒ∑ Œ°ŒØœÉŒ∫ŒøœÖ ŒïœÄŒµŒΩŒ¥œçœÉŒµœâŒΩ',
                actions: 'ŒïŒΩŒ≠œÅŒ≥ŒµŒπŒµœÇ',
                real_estate_portfolio: 'ŒßŒ±œÅœÑŒøœÜœÖŒªŒ¨Œ∫ŒπŒø ŒëŒ∫ŒπŒΩŒÆœÑœâŒΩ',
                add_property: 'Œ†œÅŒøœÉŒ∏ŒÆŒ∫Œ∑ ŒëŒ∫ŒπŒΩŒÆœÑŒøœÖ',
                bank_accounts: 'Œ§œÅŒ±œÄŒµŒ∂ŒπŒ∫ŒøŒØ ŒõŒøŒ≥Œ±œÅŒπŒ±œÉŒºŒøŒØ',
                add_account: 'Œ†œÅŒøœÉŒ∏ŒÆŒ∫Œ∑ ŒõŒøŒ≥Œ±œÅŒπŒ±œÉŒºŒøœç',
                account_terms: 'ŒåœÅŒøŒπ ŒõŒøŒ≥Œ±œÅŒπŒ±œÉŒºŒøœç',
                interest_rate: 'ŒïœÄŒπœÑœåŒ∫ŒπŒø',
                lockup_period: 'Œ†ŒµœÅŒØŒøŒ¥ŒøœÇ ŒîŒ≠œÉŒºŒµœÖœÉŒ∑œÇ (ŒºŒÆŒΩŒµœÇ)',
                liabilities_debts: 'Œ•œÄŒøœáœÅŒµœéœÉŒµŒπœÇ & ŒßœÅŒ≠Œ∑',
                add_liability: 'Œ†œÅŒøœÉŒ∏ŒÆŒ∫Œ∑ Œ•œÄŒøœáœÅŒ≠œâœÉŒ∑œÇ',
                liability: 'Œ•œÄŒøœáœÅŒ≠œâœÉŒ∑',
                balance: 'Œ•œÄœåŒªŒøŒπœÄŒø',
                monthly_payment: 'ŒúŒ∑ŒΩŒπŒ±ŒØŒ± ŒîœåœÉŒ∑',
                income_sources: 'Œ†Œ∑Œ≥Œ≠œÇ ŒïŒπœÉŒøŒ¥ŒÆŒºŒ±œÑŒøœÇ',
                add_income: 'Œ†œÅŒøœÉŒ∏ŒÆŒ∫Œ∑ ŒïŒπœÉŒøŒ¥ŒÆŒºŒ±œÑŒøœÇ',
                source: 'Œ†Œ∑Œ≥ŒÆ',
                monthly_gross: 'ŒúŒ∑ŒΩŒπŒ±ŒØŒø ŒúŒπŒ∫œÑœå',
                monthly_net: 'ŒúŒ∑ŒΩŒπŒ±ŒØŒø ŒöŒ±Œ∏Œ±œÅœå',
                annual_net: 'ŒïœÑŒÆœÉŒπŒø ŒöŒ±Œ∏Œ±œÅœå',
                expense_tracking: 'Œ†Œ±œÅŒ±Œ∫ŒøŒªŒøœçŒ∏Œ∑œÉŒ∑ ŒïŒæœåŒ¥œâŒΩ',
                add_expense: 'Œ†œÅŒøœÉŒ∏ŒÆŒ∫Œ∑ ŒïŒæœåŒ¥ŒøœÖ',
                date: 'ŒóŒºŒµœÅŒøŒºŒ∑ŒΩŒØŒ±',
                description: 'Œ†ŒµœÅŒπŒ≥œÅŒ±œÜŒÆ',
                category: 'ŒöŒ±œÑŒ∑Œ≥ŒøœÅŒØŒ±',
                amount: 'Œ†ŒøœÉœå',
                monthly_budgets: 'ŒúŒ∑ŒΩŒπŒ±ŒØŒøŒπ Œ†œÅŒøœãœÄŒøŒªŒøŒ≥ŒπœÉŒºŒøŒØ',
                add_budget: 'Œ†œÅŒøœÉŒ∏ŒÆŒ∫Œ∑ Œ†œÅŒøœãœÄŒøŒªŒøŒ≥ŒπœÉŒºŒøœç',
                expense_breakdown: 'ŒëŒΩŒ¨ŒªœÖœÉŒ∑ ŒïŒæœåŒ¥œâŒΩ',
                income_vs_expenses: 'ŒïŒπœÉœåŒ¥Œ∑ŒºŒ± vs ŒàŒæŒøŒ¥Œ±',
                financial_health: 'ŒüŒπŒ∫ŒøŒΩŒøŒºŒπŒ∫ŒÆ Œ•Œ≥ŒµŒØŒ±',
                cancel: 'ŒëŒ∫œçœÅœâœÉŒ∑',
                save: 'ŒëœÄŒøŒ∏ŒÆŒ∫ŒµœÖœÉŒ∑',
                name: 'ŒåŒΩŒøŒºŒ±',
                address: 'ŒîŒπŒµœçŒ∏œÖŒΩœÉŒ∑',
                bank: 'Œ§œÅŒ¨œÄŒµŒ∂Œ±',
                employer: 'ŒïœÅŒ≥ŒøŒ¥œåœÑŒ∑œÇ',
                tax_rate: 'Œ¶ŒøœÅŒøŒªŒøŒ≥ŒπŒ∫œå Œ†ŒøœÉŒøœÉœÑœå (%)',
                monthly_rent: 'ŒúŒ∑ŒΩŒπŒ±ŒØŒø ŒïŒΩŒøŒØŒ∫ŒπŒø',
                purchase_date: 'ŒóŒºŒµœÅŒøŒºŒ∑ŒΩŒØŒ± ŒëŒ≥ŒøœÅŒ¨œÇ',
                budget_limit: 'ŒåœÅŒπŒø Œ†œÅŒøœãœÄŒøŒªŒøŒ≥ŒπœÉŒºŒøœç',
                spent_amount: 'Œ†ŒøœÉœå œÄŒøœÖ ŒûŒøŒ¥ŒµœçœÑŒ∑Œ∫Œµ',
                remaining: 'Œ•œÄœåŒªŒøŒπœÄŒø',
                over_budget: 'Œ•œÄŒ≠œÅŒ≤Œ±œÉŒ∑ Œ†œÅŒøœãœÄŒøŒªŒøŒ≥ŒπœÉŒºŒøœç',
                debt_to_asset_ratio: 'ŒëŒΩŒ±ŒªŒøŒ≥ŒØŒ± ŒßœÅŒ≠ŒøœÖœÇ œÄœÅŒøœÇ Œ†ŒµœÅŒπŒøœÖœÉŒØŒ±',
                debt_to_income_ratio: 'ŒëŒΩŒ±ŒªŒøŒ≥ŒØŒ± ŒßœÅŒ≠ŒøœÖœÇ œÄœÅŒøœÇ ŒïŒπœÉœåŒ¥Œ∑ŒºŒ±',
                savings_rate: 'Œ†ŒøœÉŒøœÉœÑœå ŒëœÄŒøœÑŒ±ŒºŒØŒµœÖœÉŒ∑œÇ',
                emergency_fund: 'Œ§Œ±ŒºŒµŒØŒø ŒàŒ∫œÑŒ±Œ∫œÑŒ∑œÇ ŒëŒΩŒ¨Œ≥Œ∫Œ∑œÇ',
                months_of_expenses: 'ŒúŒÆŒΩŒµœÇ ŒïŒæœåŒ¥œâŒΩ œÄŒøœÖ ŒöŒ±ŒªœçœÄœÑŒøŒΩœÑŒ±Œπ',
                // Asset Types
                stocks: 'ŒúŒµœÑŒøœáŒ≠œÇ',
                bonds: 'ŒüŒºœåŒªŒøŒ≥Œ±',
                etf: 'ETF',
                mutual_fund: 'ŒëŒºŒøŒπŒ≤Œ±ŒØŒø ŒöŒµœÜŒ¨ŒªŒ±ŒπŒø',
                cryptocurrency: 'ŒöœÅœÖœÄœÑŒøŒΩœåŒºŒπœÉŒºŒ±',
                index_fund: 'ŒöŒµœÜŒ¨ŒªŒ±ŒπŒø ŒîŒµŒØŒ∫œÑŒ∑',
                life_insurance: 'ŒëœÉœÜŒ¨ŒªŒµŒπŒ± ŒñœâŒÆœÇ',
                vehicle: 'ŒåœáŒ∑ŒºŒ±',
                jewelry: 'ŒöŒøœÉŒºŒÆŒºŒ±œÑŒ±',
                // Risk Levels
                low: 'ŒßŒ±ŒºŒ∑Œªœå',
                medium: 'ŒúŒ≠œÑœÅŒπŒø',
                high: 'Œ•œàŒ∑Œªœå',
                // Property Types
                residential: 'ŒöŒ±œÑŒøŒπŒ∫ŒØŒ±',
                rental: 'ŒïŒΩŒøŒØŒ∫ŒπŒø',
                commercial: 'ŒïŒºœÄŒøœÅŒπŒ∫œå',
                // Account Types
                checking: 'Œ§œÅŒµœáŒøœçŒºŒµŒΩŒøœÇ',
                savings: 'ŒëœÄŒøœÑŒ±ŒºŒπŒµœçœÉŒµœâŒΩ',
                term_deposit: 'Œ†œÅŒøŒ∏ŒµœÉŒºŒπŒ±Œ∫ŒÆ ŒöŒ±œÑŒ¨Œ∏ŒµœÉŒ∑',
                // Liability Types
                mortgage: 'Œ£œÑŒµŒ≥Œ±œÉœÑŒπŒ∫œå ŒîŒ¨ŒΩŒµŒπŒø',
                car_loan: 'ŒîŒ¨ŒΩŒµŒπŒø ŒëœÖœÑŒøŒ∫ŒπŒΩŒÆœÑŒøœÖ',
                personal_loan: 'Œ†œÅŒøœÉœâœÄŒπŒ∫œå ŒîŒ¨ŒΩŒµŒπŒø',
                credit_card: 'Œ†ŒπœÉœÑœâœÑŒπŒ∫ŒÆ ŒöŒ¨œÅœÑŒ±',
                student_loan: 'Œ¶ŒøŒπœÑŒ∑œÑŒπŒ∫œå ŒîŒ¨ŒΩŒµŒπŒø',
                // Income Types
                salary: 'ŒúŒπœÉŒ∏œåœÇ',
                freelance: 'ŒïŒªŒµœçŒ∏ŒµœÅŒøœÇ ŒïœÄŒ±Œ≥Œ≥ŒµŒªŒºŒ±œÑŒØŒ±œÇ',
                business: 'ŒïœÄŒπœáŒµŒØœÅŒ∑œÉŒ∑',
                rental: 'ŒïŒΩŒøŒØŒ∫ŒπŒø',
                dividends: 'ŒúŒµœÅŒØœÉŒºŒ±œÑŒ±',
                pension: 'Œ£œçŒΩœÑŒ±ŒæŒ∑',
                // Expense Categories
                groceries: 'Œ†Œ±ŒΩœÑŒøœÄœâŒªŒµŒØŒø',
                transportation: 'ŒúŒµœÑŒ±œÜŒøœÅŒ¨',
                dining: 'Œ¶Œ±Œ≥Œ∑œÑœå',
                utilities: 'ŒöŒøŒπŒΩœåœáœÅŒ∑œÉœÑŒ±',
                entertainment: 'ŒîŒπŒ±œÉŒ∫Œ≠Œ¥Œ±œÉŒ∑',
                health: 'Œ•Œ≥ŒµŒØŒ±',
                shopping: 'ŒëŒ≥ŒøœÅŒ≠œÇ',
                travel: 'Œ§Œ±ŒæŒØŒ¥ŒπŒ±',
                education: 'ŒïŒ∫œÄŒ±ŒØŒ¥ŒµœÖœÉŒ∑',
                insurance: 'ŒëœÉœÜŒ¨ŒªŒπœÉŒ∑',
                other: 'ŒÜŒªŒªŒ±'
            }
        };

        // Chart instances
        let chartInstances = {};

        // Utility functions
        function formatCurrency(amount, currency = currentCurrency) {
            return new Intl.NumberFormat('en-EU', {
                style: 'currency',
                currency: currency
            }).format(amount);
        }

        function translate(key) {
            return translations[currentLanguage][key] || key;
        }

        function createIcons() {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleString();
        }

        function updateLanguage() {
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                element.textContent = translate(key);
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function getRiskIndicator(riskLevel) {
            const riskIcons = {
                low: '<i data-lucide="shield" class="w-4 h-4"></i>',
                medium: '<i data-lucide="alert-triangle" class="w-4 h-4"></i>',
                high: '<i data-lucide="zap" class="w-4 h-4"></i>'
            };
            const riskColors = {
                low: 'risk-low',
                medium: 'risk-medium', 
                high: 'risk-high'
            };
            
            return `<span class="risk-indicator ${riskColors[riskLevel]}">${riskIcons[riskLevel]} ${translate(riskLevel)}</span>`;
        }

        // Navigation functions
        function switchTab(tabName) {
            activeTab = tabName;
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-gray-600');
            });
            
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.add('active');
            activeBtn.classList.remove('text-gray-600');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            const activeContent = document.getElementById(`${tabName}-content`);
            if (activeContent) {
                activeContent.classList.remove('hidden');
            }
            
            // Update page title
            document.getElementById('pageTitle').textContent = translate(tabName.replace('-', '_'));
            
            // Render content
            renderTabContent();
        }

        function renderTabContent() {
            switch (activeTab) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'assets':
                    renderAssets();
                    break;
                case 'capital-markets':
                    renderCapitalMarkets();
                    break;
                case 'real-estate':
                    renderRealEstate();
                    break;
                case 'accounts':
                    renderAccounts();
                    break;
                case 'liabilities':
                    renderLiabilities();
                    break;
                case 'income':
                    renderIncome();
                    break;
                case 'expenses':
                    renderExpenses();
                    break;
                case 'budgets':
                    renderBudgets();
                    break;
                case 'analytics':
                    renderAnalytics();
                    break;
            }
        }

        // Enhanced calculation functions
        function calculateTotalAssets() {
            const capitalMarketsValue = capitalMarkets.reduce((sum, inv) => {
                if (inv.type === 'life_insurance') {
                    return sum + (inv.currentValue || inv.purchasePrice);
                }
                return sum + (inv.quantity * inv.currentPrice);
            }, 0);
            const propertyValue = properties.reduce((sum, prop) => sum + prop.currentValue, 0);
            const accountValue = accounts.reduce((sum, acc) => sum + acc.balance, 0);
            const otherAssetsValue = otherAssets.reduce((sum, asset) => sum + asset.value, 0);
            return capitalMarketsValue + propertyValue + accountValue + otherAssetsValue;
        }

        function calculateInvestedCapital() {
            // Capital markets investments
            const capitalMarketsValue = capitalMarkets.reduce((sum, inv) => {
                if (inv.type === 'life_insurance') {
                    return sum + (inv.currentValue || inv.purchasePrice);
                }
                return sum + (inv.quantity * inv.currentPrice);
            }, 0);
            
            // Real estate
            const propertyValue = properties.reduce((sum, prop) => sum + prop.currentValue, 0);
            
            // Interest-bearing accounts
            const interestBearingAccounts = accounts
                .filter(acc => acc.interestRate && acc.interestRate > 0)
                .reduce((sum, acc) => sum + acc.balance, 0);
            
            return capitalMarketsValue + propertyValue + interestBearingAccounts;
        }

        function calculateTotalLiabilities() {
            return liabilities.reduce((sum, liability) => sum + liability.balance, 0);
        }

        function calculateNetWorth() {
            return calculateTotalAssets() - calculateTotalLiabilities();
        }

        function calculateMonthlyIncome() {
            return incomes.reduce((sum, income) => {
                return sum + (income.monthlyGross * (1 - income.taxRate / 100));
            }, 0);
        }

        function calculateMonthlyExpenses() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            return expenses
                .filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
                })
                .reduce((sum, expense) => sum + expense.amount, 0);
        }

        function calculateRiskMetrics() {
            const totalCapitalMarkets = capitalMarkets.reduce((sum, inv) => {
                if (inv.type === 'life_insurance') {
                    return sum + (inv.currentValue || inv.purchasePrice);
                }
                return sum + (inv.quantity * inv.currentPrice);
            }, 0);

            const riskBreakdown = capitalMarkets.reduce((acc, inv) => {
                const value = inv.type === 'life_insurance' ? 
                    (inv.currentValue || inv.purchasePrice) : 
                    (inv.quantity * inv.currentPrice);
                
                if (!acc[inv.riskLevel]) acc[inv.riskLevel] = 0;
                acc[inv.riskLevel] += value;
                return acc;
            }, {});

            return {
                low: ((riskBreakdown.low || 0) / totalCapitalMarkets * 100) || 0,
                medium: ((riskBreakdown.medium || 0) / totalCapitalMarkets * 100) || 0,
                high: ((riskBreakdown.high || 0) / totalCapitalMarkets * 100) || 0,
                totalValue: totalCapitalMarkets
            };
        }

        // Enhanced render functions
        function renderDashboard() {
            const totalAssets = calculateTotalAssets();
            const totalLiabilities = calculateTotalLiabilities();
            const netWorth = calculateNetWorth();
            const investedCapital = calculateInvestedCapital();
            const monthlyIncome = calculateMonthlyIncome();
            const monthlyExpenses = calculateMonthlyExpenses();

            // Update dashboard stats
            document.getElementById('netWorthValue').textContent = formatCurrency(netWorth);
            document.getElementById('totalAssetsValue').textContent = formatCurrency(totalAssets);
            document.getElementById('investedCapitalValue').textContent = formatCurrency(investedCapital);
            document.getElementById('monthlyIncomeValue').textContent = formatCurrency(monthlyIncome);
            document.getElementById('monthlyExpensesValue').textContent = formatCurrency(monthlyExpenses);

            // Render charts
            renderChart('assetAllocationChart', 'doughnut', getAssetAllocationData());
            renderChart('netWorthChart', 'line', getNetWorthTrendData());
            
            // Render recent transactions
            renderRecentTransactions();
            renderBudgetOverview();
        }

        function renderAssets() {
            renderChart('assetBreakdownChart', 'bar', getAssetBreakdownData());
            renderAssetSummary();
        }

        function renderCapitalMarkets() {
            const tableBody = document.getElementById('capitalMarketsTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = capitalMarkets.map(investment => {
                let totalValue, gainLoss, gainLossPercent;
                
                if (investment.type === 'life_insurance') {
                    totalValue = investment.currentValue || investment.purchasePrice;
                    gainLoss = totalValue - investment.purchasePrice;
                    gainLossPercent = investment.purchasePrice > 0 ? (gainLoss / investment.purchasePrice * 100) : 0;
                } else {
                    totalValue = investment.quantity * investment.currentPrice;
                    const purchaseValue = investment.quantity * investment.purchasePrice;
                    gainLoss = totalValue - purchaseValue;
                    gainLossPercent = purchaseValue > 0 ? (gainLoss / purchaseValue * 100) : 0;
                }
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${investment.name}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${translate(investment.type)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${formatCurrency(investment.monthlyInvestment || 0, investment.currency)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            ${getRiskIndicator(investment.riskLevel || 'medium')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${formatCurrency(totalValue, investment.currency)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${gainLoss >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${formatCurrency(gainLoss, investment.currency)} (${gainLossPercent.toFixed(2)}%)
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <button onclick="editItem('capital_market', '${investment.id}')" class="text-blue-600 hover:text-blue-900 mr-2">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteItem('capital_market', '${investment.id}')" class="text-red-600 hover:text-red-900">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            createIcons();
        }

        function renderRealEstate() {
            const propertiesGrid = document.getElementById('propertiesGrid');
            if (!propertiesGrid) return;
            
            propertiesGrid.innerHTML = properties.map(property => {
                const appreciation = property.currentValue - property.purchasePrice;
                const appreciationPercent = property.purchasePrice > 0 ? (appreciation / property.purchasePrice) * 100 : 0;
                
                return `
                    <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-shadow">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900">${property.name}</h4>
                            <div class="flex space-x-2">
                                <button onclick="editItem('property', '${property.id}')" class="text-blue-600 hover:text-blue-900">
                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                </button>
                                <button onclick="deleteItem('property', '${property.id}')" class="text-red-600 hover:text-red-900">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <p class="text-sm text-gray-600">${property.address}</p>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">${translate('current_value')}:</span>
                                <span class="text-sm font-medium">${formatCurrency(property.currentValue, property.currency)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">${translate('gain_loss')}:</span>
                                <span class="text-sm font-medium ${appreciation >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${formatCurrency(appreciation, property.currency)} (${appreciationPercent.toFixed(2)}%)
                                </span>
                            </div>
                            ${property.type === 'rental' ? `
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-500">${translate('monthly_rent')}:</span>
                                    <span class="text-sm font-medium text-green-600">${formatCurrency(property.monthlyRent, property.currency)}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            createIcons();
        }

        function renderAccounts() {
            const accountsGrid = document.getElementById('accountsGrid');
            if (!accountsGrid) return;
            
            accountsGrid.innerHTML = accounts.map(account => `
                <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-900">${account.name}</h4>
                        <div class="flex space-x-2">
                            <button onclick="editItem('account', '${account.id}')" class="text-blue-600 hover:text-blue-900">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteItem('account', '${account.id}')" class="text-red-600 hover:text-red-900">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-sm text-gray-600">${account.bank}</p>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500">${translate('type')}:</span>
                            <span class="text-sm font-medium">${translate(account.type)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500">${translate('balance')}:</span>
                            <span class="text-lg font-bold ${(account.interestRate && account.interestRate > 0) ? 'text-purple-600' : 'text-green-600'}">${formatCurrency(account.balance, account.currency)}</span>
                        </div>
                        ${account.interestRate && account.interestRate > 0 ? `
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">${translate('interest_rate')}:</span>
                                <span class="text-sm font-medium text-blue-600">${account.interestRate}%</span>
                            </div>
                        ` : ''}
                        ${account.lockupPeriod && account.lockupPeriod > 0 ? `
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">${translate('lockup_period')}:</span>
                                <span class="text-sm font-medium">${account.lockupPeriod} months</span>
                            </div>
                        ` : ''}
                        ${account.terms ? `
                            <div class="mt-3 p-2 bg-gray-50 rounded">
                                <p class="text-xs text-gray-600">${account.terms}</p>
                            </div>
                        ` : ''}
                        ${(account.interestRate && account.interestRate > 0) ? `
                            <div class="mt-2 p-2 bg-purple-50 rounded">
                                <p class="text-xs text-purple-700 font-medium">üíº Invested Capital</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            createIcons();
        }

        function renderLiabilities() {
            const tableBody = document.getElementById('liabilitiesTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = liabilities.map(liability => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${liability.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            ${translate(liability.type)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-600">
                        ${formatCurrency(liability.balance, liability.currency)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${liability.interestRate}%
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${formatCurrency(liability.monthlyPayment, liability.currency)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="editItem('liability', '${liability.id}')" class="text-blue-600 hover:text-blue-900 mr-2">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteItem('liability', '${liability.id}')" class="text-red-600 hover:text-red-900">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            createIcons();
        }

        function renderIncome() {
            const tableBody = document.getElementById('incomeTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = incomes.map(income => {
                const monthlyNet = income.monthlyGross * (1 - income.taxRate / 100);
                const annualNet = monthlyNet * 12;
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${income.name}</div>
                            <div class="text-sm text-gray-500">${income.employer}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                ${translate(income.type)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${formatCurrency(income.monthlyGross, income.currency)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600">
                            ${formatCurrency(monthlyNet, income.currency)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${formatCurrency(annualNet, income.currency)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <button onclick="editItem('income', '${income.id}')" class="text-blue-600 hover:text-blue-900 mr-2">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteItem('income', '${income.id}')" class="text-red-600 hover:text-red-900">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            createIcons();
        }

        function renderExpenses() {
            const tableBody = document.getElementById('expensesTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = expenses.map(expense => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${expense.date}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${expense.description}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            ${translate(expense.category)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${formatCurrency(expense.amount, expense.currency)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="editItem('expense', '${expense.id}')" class="text-blue-600 hover:text-blue-900 mr-2">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteItem('expense', '${expense.id}')" class="text-red-600 hover:text-red-900">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            createIcons();
        }

        function renderBudgets() {
            const budgetsGrid = document.getElementById('budgetsGrid');
            if (!budgetsGrid) return;
            
            budgetsGrid.innerHTML = budgets.map(budget => {
                const percentage = budget.amount > 0 ? (budget.spent / budget.amount) * 100 : 0;
                const remaining = budget.amount - budget.spent;
                const status = percentage > 100 ? 'over' : percentage > 80 ? 'warning' : 'good';
                
                return `
                    <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-shadow">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900">${translate(budget.category)}</h4>
                            <div class="flex space-x-2">
                                <button onclick="editItem('budget', '${budget.id}')" class="text-blue-600 hover:text-blue-900">
                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                </button>
                                <button onclick="deleteItem('budget', '${budget.id}')" class="text-red-600 hover:text-red-900">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>${translate('spent_amount')}: ${formatCurrency(budget.spent, budget.currency)}</span>
                                <span>${translate('budget_limit')}: ${formatCurrency(budget.amount, budget.currency)}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="progress-bar ${status === 'over' ? 'bg-red-500' : status === 'warning' ? 'bg-yellow-500' : 'bg-green-500'} h-2 rounded-full" 
                                     style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                            <div class="text-sm ${remaining >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${remaining >= 0 ? translate('remaining') : translate('over_budget')}: ${formatCurrency(Math.abs(remaining), budget.currency)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            createIcons();
        }

        function renderAnalytics() {
            renderInvestmentRiskMetrics();
            renderChart('riskAllocationChart', 'doughnut', getRiskAllocationData());
            renderChart('expenseBreakdownChart', 'pie', getExpenseBreakdownData());
            renderChart('incomeVsExpensesChart', 'bar', getIncomeVsExpensesData());
            renderFinancialHealthMetrics();
        }

        function renderRecentTransactions() {
            const container = document.getElementById('recentTransactions');
            if (!container) return;
            
            const recentExpenses = expenses.slice(-5).reverse();
            
            container.innerHTML = recentExpenses.map(expense => `
                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 bg-red-100 rounded-lg">
                            <i data-lucide="minus" class="w-4 h-4 text-red-600"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${expense.description}</p>
                            <p class="text-xs text-gray-500">${expense.date} ‚Ä¢ ${translate(expense.category)}</p>
                        </div>
                    </div>
                    <p class="text-sm font-medium text-red-600">${formatCurrency(expense.amount, expense.currency)}</p>
                </div>
            `).join('');
            createIcons();
        }

        function renderBudgetOverview() {
            const container = document.getElementById('budgetOverview');
            if (!container) return;
            
            container.innerHTML = budgets.slice(0, 3).map(budget => {
                const percentage = budget.amount > 0 ? (budget.spent / budget.amount) * 100 : 0;
                const status = percentage > 100 ? 'over' : percentage > 80 ? 'warning' : 'good';
                
                return `
                    <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-900">${translate(budget.category)}</span>
                            <span class="text-sm font-medium ${status === 'over' ? 'text-red-600' : 'text-gray-600'}">${percentage.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="progress-bar ${status === 'over' ? 'bg-red-500' : status === 'warning' ? 'bg-yellow-500' : 'bg-green-500'} h-2 rounded-full" 
                                 style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAssetSummary() {
            const container = document.getElementById('assetSummary');
            if (!container) return;
            
            const capitalMarketsValue = capitalMarkets.reduce((sum, inv) => {
                if (inv.type === 'life_insurance') {
                    return sum + (inv.currentValue || inv.purchasePrice);
                }
                return sum + (inv.quantity * inv.currentPrice);
            }, 0);
            const propertyValue = properties.reduce((sum, prop) => sum + prop.currentValue, 0);
            const accountValue = accounts.reduce((sum, acc) => sum + acc.balance, 0);
            const otherAssetsValue = otherAssets.reduce((sum, asset) => sum + asset.value, 0);
            
            container.innerHTML = `
                <div class="p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-medium text-blue-900">${translate('capital_markets')}</h4>
                    <p class="text-2xl font-bold text-blue-600">${formatCurrency(capitalMarketsValue)}</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                    <h4 class="font-medium text-green-900">${translate('real_estate')}</h4>
                    <p class="text-2xl font-bold text-green-600">${formatCurrency(propertyValue)}</p>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg">
                    <h4 class="font-medium text-purple-900">${translate('accounts')}</h4>
                    <p class="text-2xl font-bold text-purple-600">${formatCurrency(accountValue)}</p>
                </div>
                <div class="p-4 bg-orange-50 rounded-lg">
                    <h4 class="font-medium text-orange-900">Other Assets</h4>
                    <p class="text-2xl font-bold text-orange-600">${formatCurrency(otherAssetsValue)}</p>
                </div>
            `;
        }

        function renderInvestmentRiskMetrics() {
            const container = document.getElementById('investmentRiskMetrics');
            if (!container) return;
            
            const riskMetrics = calculateRiskMetrics();
            
            container.innerHTML = `
                <div class="p-6 bg-green-50 rounded-lg">
                    <h4 class="font-medium text-green-900 mb-2">${translate('low')} ${translate('risk_level')}</h4>
                    <div class="flex items-center space-x-3">
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full progress-bar" style="width: ${riskMetrics.low}%"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900">${riskMetrics.low.toFixed(1)}%</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">${formatCurrency(riskMetrics.totalValue * riskMetrics.low / 100)}</p>
                </div>
                <div class="p-6 bg-yellow-50 rounded-lg">
                    <h4 class="font-medium text-yellow-900 mb-2">${translate('medium')} ${translate('risk_level')}</h4>
                    <div class="flex items-center space-x-3">
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                            <div class="bg-yellow-500 h-2 rounded-full progress-bar" style="width: ${riskMetrics.medium}%"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900">${riskMetrics.medium.toFixed(1)}%</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">${formatCurrency(riskMetrics.totalValue * riskMetrics.medium / 100)}</p>
                </div>
                <div class="p-6 bg-red-50 rounded-lg">
                    <h4 class="font-medium text-red-900 mb-2">${translate('high')} ${translate('risk_level')}</h4>
                    <div class="flex items-center space-x-3">
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                            <div class="bg-red-500 h-2 rounded-full progress-bar" style="width: ${riskMetrics.high}%"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900">${riskMetrics.high.toFixed(1)}%</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">${formatCurrency(riskMetrics.totalValue * riskMetrics.high / 100)}</p>
                </div>
            `;
        }

        function renderFinancialHealthMetrics() {
            const container = document.getElementById('financialHealthMetrics');
            if (!container) return;
            
            const totalAssets = calculateTotalAssets();
            const totalLiabilities = calculateTotalLiabilities();
            const monthlyIncome = calculateMonthlyIncome();
            const monthlyExpenses = calculateMonthlyExpenses();
            const monthlyDebtPayments = liabilities.reduce((sum, liability) => sum + liability.monthlyPayment, 0);
            
            const debtToAssetRatio = totalAssets > 0 ? (totalLiabilities / totalAssets) * 100 : 0;
            const debtToIncomeRatio = monthlyIncome > 0 ? (monthlyDebtPayments / monthlyIncome) * 100 : 0;
            const savingsRate = monthlyIncome > 0 ? ((monthlyIncome - monthlyExpenses) / monthlyIncome) * 100 : 0;
            
            container.innerHTML = `
                <div class="p-6 bg-gray-50 rounded-lg">
                    <h4 class="font-medium text-gray-900 mb-2">${translate('debt_to_asset_ratio')}</h4>
                    <div class="flex items-center space-x-3">
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                            <div class="${debtToAssetRatio < 30 ? 'bg-green-500' : debtToAssetRatio < 50 ? 'bg-yellow-500' : 'bg-red-500'} h-2 rounded-full progress-bar" 
                                 style="width: ${Math.min(debtToAssetRatio, 100)}%"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900">${debtToAssetRatio.toFixed(1)}%</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Target: Below 30%</p>
                </div>
                <div class="p-6 bg-gray-50 rounded-lg">
                    <h4 class="font-medium text-gray-900 mb-2">${translate('debt_to_income_ratio')}</h4>
                    <div class="flex items-center space-x-3">
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                            <div class="${debtToIncomeRatio < 28 ? 'bg-green-500' : debtToIncomeRatio < 40 ? 'bg-yellow-500' : 'bg-red-500'} h-2 rounded-full progress-bar" 
                                 style="width: ${Math.min(debtToIncomeRatio, 100)}%"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900">${debtToIncomeRatio.toFixed(1)}%</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Target: Below 28%</p>
                </div>
                <div class="p-6 bg-gray-50 rounded-lg">
                    <h4 class="font-medium text-gray-900 mb-2">${translate('savings_rate')}</h4>
                    <div class="flex items-center space-x-3">
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                            <div class="${savingsRate > 20 ? 'bg-green-500' : savingsRate > 10 ? 'bg-yellow-500' : 'bg-red-500'} h-2 rounded-full progress-bar" 
                                 style="width: ${Math.min(Math.max(savingsRate, 0), 100)}%"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900">${savingsRate.toFixed(1)}%</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Target: Above 20%</p>
                </div>
            `;
        }

        // Chart functions
        function renderChart(canvasId, type, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }
            
            try {
                chartInstances[canvasId] = new Chart(ctx, {
                    type: type,
                    data: data,
                    options: getChartOptions(type)
                });
            } catch (error) {
                console.warn(`Could not create chart ${canvasId}:`, error);
            }
        }

        function getChartOptions(type) {
            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            };

            if (type === 'line') {
                baseOptions.scales = {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            maxTicksLimit: 6,
                            callback: function(value) {
                                return new Intl.NumberFormat('en-US', {
                                    notation: 'compact',
                                    compactDisplay: 'short'
                                }).format(value);
                            }
                        }
                    }
                };
            } else if (type === 'bar') {
                baseOptions.scales = {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            maxTicksLimit: 6,
                            callback: function(value) {
                                return new Intl.NumberFormat('en-US', {
                                    notation: 'compact',
                                    compactDisplay: 'short'
                                }).format(value);
                            }
                        }
                    }
                };
            }

            return baseOptions;
        }

        function getAssetAllocationData() {
            const capitalMarketsValue = capitalMarkets.reduce((sum, inv) => {
                if (inv.type === 'life_insurance') {
                    return sum + (inv.currentValue || inv.purchasePrice);
                }
                return sum + (inv.quantity * inv.currentPrice);
            }, 0);
            const propertyValue = properties.reduce((sum, prop) => sum + prop.currentValue, 0);
            const accountValue = accounts.reduce((sum, acc) => sum + acc.balance, 0);
            const otherAssetsValue = otherAssets.reduce((sum, asset) => sum + asset.value, 0);
            
            return {
                labels: [translate('capital_markets'), translate('real_estate'), translate('accounts'), 'Other Assets'],
                datasets: [{
                    data: [capitalMarketsValue, propertyValue, accountValue, otherAssetsValue],
                    backgroundColor: ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B']
                }]
            };
        }

        function getAssetBreakdownData() {
            const capitalMarketsValue = capitalMarkets.reduce((sum, inv) => {
                if (inv.type === 'life_insurance') {
                    return sum + (inv.currentValue || inv.purchasePrice);
                }
                return sum + (inv.quantity * inv.currentPrice);
            }, 0);
            const propertyValue = properties.reduce((sum, prop) => sum + prop.currentValue, 0);
            const accountValue = accounts.reduce((sum, acc) => sum + acc.balance, 0);
            const otherAssetsValue = otherAssets.reduce((sum, asset) => sum + asset.value, 0);
            
            return {
                labels: [translate('capital_markets'), translate('real_estate'), translate('accounts'), 'Other Assets'],
                datasets: [{
                    label: translate('total_value'),
                    data: [capitalMarketsValue, propertyValue, accountValue, otherAssetsValue],
                    backgroundColor: ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B']
                }]
            };
        }

        function getRiskAllocationData() {
            const riskMetrics = calculateRiskMetrics();
            
            return {
                labels: [translate('low'), translate('medium'), translate('high')],
                datasets: [{
                    data: [riskMetrics.low, riskMetrics.medium, riskMetrics.high],
                    backgroundColor: ['#10B981', '#F59E0B', '#EF4444']
                }]
            };
        }

        function getNetWorthTrendData() {
            // Sample data for the trend - in a real app, this would come from historical data
            return {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: translate('net_worth'),
                    data: [180000, 185000, 190000, 188000, 195000, calculateNetWorth()],
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            };
        }

        function getExpenseBreakdownData() {
            const expensesByCategory = {};
            expenses.forEach(expense => {
                if (!expensesByCategory[expense.category]) {
                    expensesByCategory[expense.category] = 0;
                }
                expensesByCategory[expense.category] += expense.amount;
            });

            return {
                labels: Object.keys(expensesByCategory).map(cat => translate(cat)),
                datasets: [{
                    data: Object.values(expensesByCategory),
                    backgroundColor: [
                        '#EF4444', '#F59E0B', '#10B981', '#3B82F6', 
                        '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'
                    ]
                }]
            };
        }

        function getIncomeVsExpensesData() {
            const monthlyIncome = calculateMonthlyIncome();
            const monthlyExpenses = calculateMonthlyExpenses();
            
            return {
                labels: [translate('monthly_income'), translate('monthly_expenses')],
                datasets: [{
                    label: translate('amount'),
                    data: [monthlyIncome, monthlyExpenses],
                    backgroundColor: ['#10B981', '#EF4444']
                }]
            };
        }

        // Modal functions
        function openModal(type, id = null) {
            currentModalType = type;
            editingId = id;
            
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            // Set modal title
            if (id) {
                modalTitle.textContent = `Edit ${translate(type)}`;
            } else {
                modalTitle.textContent = `${translate('add_item')} - ${translate(type)}`;
            }
            
            // Generate form based on type
            modalForm.innerHTML = generateForm(type, id);
            
            modal.classList.remove('hidden');
            createIcons();
        }

        function closeModal() {
            document.getElementById('addModal').classList.add('hidden');
            currentModalType = '';
            editingId = null;
        }

        function generateForm(type, id = null) {
            let item = null;
            if (id) {
                switch (type) {
                    case 'capital_market':
                        item = capitalMarkets.find(inv => inv.id === id);
                        break;
                    case 'property':
                        item = properties.find(prop => prop.id === id);
                        break;
                    case 'account':
                        item = accounts.find(acc => acc.id === id);
                        break;
                    case 'liability':
                        item = liabilities.find(lib => lib.id === id);
                        break;
                    case 'income':
                        item = incomes.find(inc => inc.id === id);
                        break;
                    case 'expense':
                        item = expenses.find(exp => exp.id === id);
                        break;
                    case 'budget':
                        item = budgets.find(bud => bud.id === id);
                        break;
                }
            }

            switch (type) {
                case 'capital_market':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('name')}</label>
                            <input type="text" id="capitalMarketName" value="${item?.name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Apple Inc. (AAPL)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('type')}</label>
                            <select id="capitalMarketType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="stocks" ${item?.type === 'stocks' ? 'selected' : ''}>${translate('stocks')}</option>
                                <option value="bonds" ${item?.type === 'bonds' ? 'selected' : ''}>${translate('bonds')}</option>
                                <option value="etf" ${item?.type === 'etf' ? 'selected' : ''}>${translate('etf')}</option>
                                <option value="mutual_fund" ${item?.type === 'mutual_fund' ? 'selected' : ''}>${translate('mutual_fund')}</option>
                                <option value="cryptocurrency" ${item?.type === 'cryptocurrency' ? 'selected' : ''}>${translate('cryptocurrency')}</option>
                                <option value="index_fund" ${item?.type === 'index_fund' ? 'selected' : ''}>${translate('index_fund')}</option>
                                <option value="life_insurance" ${item?.type === 'life_insurance' ? 'selected' : ''}>${translate('life_insurance')}</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4" id="quantityPriceSection" style="display: ${item?.type === 'life_insurance' ? 'none' : 'grid'}">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">${translate('quantity')}</label>
                                <input type="number" id="capitalMarketQuantity" value="${item?.quantity || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">${translate('purchase_price')}</label>
                                <input type="number" id="capitalMarketPurchasePrice" value="${item?.purchasePrice || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div id="currentPriceSection" style="display: ${item?.type === 'life_insurance' ? 'none' : 'block'}">
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('current_price')}</label>
                            <input type="number" id="capitalMarketCurrentPrice" value="${item?.currentPrice || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div id="lifeInsuranceSection" style="display: ${item?.type === 'life_insurance' ? 'block' : 'none'}">
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('current_value')}</label>
                            <input type="number" id="capitalMarketCurrentValue" value="${item?.currentValue || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('monthly_investment')}</label>
                            <input type="number" id="capitalMarketMonthlyInvestment" value="${item?.monthlyInvestment || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('risk_level')}</label>
                            <select id="capitalMarketRiskLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="low" ${item?.riskLevel === 'low' ? 'selected' : ''}>${translate('low')}</option>
                                <option value="medium" ${item?.riskLevel === 'medium' ? 'selected' : ''}>${translate('medium')}</option>
                                <option value="high" ${item?.riskLevel === 'high' ? 'selected' : ''}>${translate('high')}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                            <select id="capitalMarketCurrency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="EUR" ${item?.currency === 'EUR' ? 'selected' : ''}>EUR</option>
                                <option value="USD" ${item?.currency === 'USD' ? 'selected' : ''}>USD</option>
                                <option value="GBP" ${item?.currency === 'GBP' ? 'selected' : ''}>GBP</option>
                            </select>
                        </div>
                    `;

                case 'property':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('name')}</label>
                            <input type="text" id="propertyName" value="${item?.name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Main Residence">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('address')}</label>
                            <input type="text" id="propertyAddress" value="${item?.address || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="123 Main St, Athens">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('type')}</label>
                            <select id="propertyType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="residential" ${item?.type === 'residential' ? 'selected' : ''}>${translate('residential')}</option>
                                <option value="rental" ${item?.type === 'rental' ? 'selected' : ''}>${translate('rental')}</option>
                                <option value="commercial" ${item?.type === 'commercial' ? 'selected' : ''}>${translate('commercial')}</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">${translate('purchase_price')}</label>
                                <input type="number" id="propertyPurchasePrice" value="${item?.purchasePrice || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">${translate('current_value')}</label>
                                <input type="number" id="propertyCurrentValue" value="${item?.currentValue || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div id="rentalSection" style="display: ${item?.type === 'rental' ? 'block' : 'none'}">
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('monthly_rent')}</label>
                            <input type="number" id="propertyMonthlyRent" value="${item?.monthlyRent || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                            <select id="propertyCurrency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="EUR" ${item?.currency === 'EUR' ? 'selected' : ''}>EUR</option>
                                <option value="USD" ${item?.currency === 'USD' ? 'selected' : ''}>USD</option>
                                <option value="GBP" ${item?.currency === 'GBP' ? 'selected' : ''}>GBP</option>
                            </select>
                        </div>
                    `;

                case 'account':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('name')}</label>
                            <input type="text" id="accountName" value="${item?.name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Alpha Bank Checking">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('bank')}</label>
                            <input type="text" id="accountBank" value="${item?.bank || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Alpha Bank">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('type')}</label>
                            <select id="accountType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="checking" ${item?.type === 'checking' ? 'selected' : ''}>${translate('checking')}</option>
                                <option value="savings" ${item?.type === 'savings' ? 'selected' : ''}>${translate('savings')}</option>
                                <option value="term_deposit" ${item?.type === 'term_deposit' ? 'selected' : ''}>${translate('term_deposit')}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('balance')}</label>
                            <input type="number" id="accountBalance" value="${item?.balance || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('account_terms')}</label>
                            <textarea id="accountTerms" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Account terms and conditions">${item?.terms || ''}</textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4" id="interestSection" style="display: ${(item?.type === 'savings' || item?.type === 'term_deposit') ? 'grid' : 'none'}">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">${translate('interest_rate')} (%)</label>
                                <input type="number" id="accountInterestRate" value="${item?.interestRate || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div id="lockupSection" style="display: ${item?.type === 'term_deposit' ? 'block' : 'none'}">
                                <label class="block text-sm font-medium text-gray-700 mb-1">${translate('lockup_period')}</label>
                                <input type="number" id="accountLockupPeriod" value="${item?.lockupPeriod || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                            <select id="accountCurrency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="EUR" ${item?.currency === 'EUR' ? 'selected' : ''}>EUR</option>
                                <option value="USD" ${item?.currency === 'USD' ? 'selected' : ''}>USD</option>
                                <option value="GBP" ${item?.currency === 'GBP' ? 'selected' : ''}>GBP</option>
                            </select>
                        </div>
                    `;

                case 'liability':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('name')}</label>
                            <input type="text" id="liabilityName" value="${item?.name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Home Mortgage">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('type')}</label>
                            <select id="liabilityType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="mortgage" ${item?.type === 'mortgage' ? 'selected' : ''}>${translate('mortgage')}</option>
                                <option value="car_loan" ${item?.type === 'car_loan' ? 'selected' : ''}>${translate('car_loan')}</option>
                                <option value="personal_loan" ${item?.type === 'personal_loan' ? 'selected' : ''}>${translate('personal_loan')}</option>
                                <option value="credit_card" ${item?.type === 'credit_card' ? 'selected' : ''}>${translate('credit_card')}</option>
                                <option value="student_loan" ${item?.type === 'student_loan' ? 'selected' : ''}>${translate('student_loan')}</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">${translate('balance')}</label>
                                <input type="number" id="liabilityBalance" value="${item?.balance || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">${translate('interest_rate')} (%)</label>
                                <input type="number" id="liabilityInterestRate" value="${item?.interestRate || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('monthly_payment')}</label>
                            <input type="number" id="liabilityMonthlyPayment" value="${item?.monthlyPayment || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                            <select id="liabilityCurrency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="EUR" ${item?.currency === 'EUR' ? 'selected' : ''}>EUR</option>
                                <option value="USD" ${item?.currency === 'USD' ? 'selected' : ''}>USD</option>
                                <option value="GBP" ${item?.currency === 'GBP' ? 'selected' : ''}>GBP</option>
                            </select>
                        </div>
                    `;

                case 'income':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('name')}</label>
                            <input type="text" id="incomeName" value="${item?.name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Primary Salary">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('type')}</label>
                            <select id="incomeType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="salary" ${item?.type === 'salary' ? 'selected' : ''}>${translate('salary')}</option>
                                <option value="freelance" ${item?.type === 'freelance' ? 'selected' : ''}>${translate('freelance')}</option>
                                <option value="business" ${item?.type === 'business' ? 'selected' : ''}>${translate('business')}</option>
                                <option value="rental" ${item?.type === 'rental' ? 'selected' : ''}>${translate('rental')}</option>
                                <option value="dividends" ${item?.type === 'dividends' ? 'selected' : ''}>${translate('dividends')}</option>
                                <option value="pension" ${item?.type === 'pension' ? 'selected' : ''}>${translate('pension')}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('employer')}</label>
                            <input type="text" id="incomeEmployer" value="${item?.employer || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tech Company Ltd">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">${translate('monthly_gross')}</label>
                                <input type="number" id="incomeMonthlyGross" value="${item?.monthlyGross || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">${translate('tax_rate')}</label>
                                <input type="number" id="incomeTaxRate" value="${item?.taxRate || ''}" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                            <select id="incomeCurrency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="EUR" ${item?.currency === 'EUR' ? 'selected' : ''}>EUR</option>
                                <option value="USD" ${item?.currency === 'USD' ? 'selected' : ''}>USD</option>
                                <option value="GBP" ${item?.currency === 'GBP' ? 'selected' : ''}>GBP</option>
                            </select>
                        </div>
                    `;

                case 'expense':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('date')}</label>
                            <input type="date" id="expenseDate" value="${item?.date || new Date().toISOString().split('T')[0]}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('description')}</label>
                            <input type="text" id="expenseDescription" value="${item?.description || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Supermarket Shopping">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('category')}</label>
                            <select id="expenseCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="groceries" ${item?.category === 'groceries' ? 'selected' : ''}>${translate('groceries')}</option>
                                <option value="transportation" ${item?.category === 'transportation' ? 'selected' : ''}>${translate('transportation')}</option>
                                <option value="dining" ${item?.category === 'dining' ? 'selected' : ''}>${translate('dining')}</option>
                                <option value="utilities" ${item?.category === 'utilities' ? 'selected' : ''}>${translate('utilities')}</option>
                                <option value="entertainment" ${item?.category === 'entertainment' ? 'selected' : ''}>${translate('entertainment')}</option>
                                <option value="health" ${item?.category === 'health' ? 'selected' : ''}>${translate('health')}</option>
                                <option value="shopping" ${item?.category === 'shopping' ? 'selected' : ''}>${translate('shopping')}</option>
                                <option value="travel" ${item?.category === 'travel' ? 'selected' : ''}>${translate('travel')}</option>
                                <option value="education" ${item?.category === 'education' ? 'selected' : ''}>${translate('education')}</option>
                                <option value="insurance" ${item?.category === 'insurance' ? 'selected' : ''}>${translate('insurance')}</option>
                                <option value="other" ${item?.category === 'other' ? 'selected' : ''}>${translate('other')}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('amount')}</label>
                            <input type="number" id="expenseAmount" value="${item?.amount || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                            <select id="expenseCurrency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="EUR" ${item?.currency === 'EUR' ? 'selected' : ''}>EUR</option>
                                <option value="USD" ${item?.currency === 'USD' ? 'selected' : ''}>USD</option>
                                <option value="GBP" ${item?.currency === 'GBP' ? 'selected' : ''}>GBP</option>
                            </select>
                        </div>
                    `;

                case 'budget':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('category')}</label>
                            <select id="budgetCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="groceries" ${item?.category === 'groceries' ? 'selected' : ''}>${translate('groceries')}</option>
                                <option value="transportation" ${item?.category === 'transportation' ? 'selected' : ''}>${translate('transportation')}</option>
                                <option value="dining" ${item?.category === 'dining' ? 'selected' : ''}>${translate('dining')}</option>
                                <option value="utilities" ${item?.category === 'utilities' ? 'selected' : ''}>${translate('utilities')}</option>
                                <option value="entertainment" ${item?.category === 'entertainment' ? 'selected' : ''}>${translate('entertainment')}</option>
                                <option value="health" ${item?.category === 'health' ? 'selected' : ''}>${translate('health')}</option>
                                <option value="shopping" ${item?.category === 'shopping' ? 'selected' : ''}>${translate('shopping')}</option>
                                <option value="travel" ${item?.category === 'travel' ? 'selected' : ''}>${translate('travel')}</option>
                                <option value="education" ${item?.category === 'education' ? 'selected' : ''}>${translate('education')}</option>
                                <option value="insurance" ${item?.category === 'insurance' ? 'selected' : ''}>${translate('insurance')}</option>
                                <option value="other" ${item?.category === 'other' ? 'selected' : ''}>${translate('other')}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('budget_limit')}</label>
                            <input type="number" id="budgetAmount" value="${item?.amount || ''}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${translate('spent_amount')}</label>
                            <input type="number" id="budgetSpent" value="${item?.spent || 0}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                            <select id="budgetCurrency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="EUR" ${item?.currency === 'EUR' ? 'selected' : ''}>EUR</option>
                                <option value="USD" ${item?.currency === 'USD' ? 'selected' : ''}>USD</option>
                                <option value="GBP" ${item?.currency === 'GBP' ? 'selected' : ''}>GBP</option>
                            </select>
                        </div>
                    `;

                default:
                    return '<p>Unknown item type</p>';
            }
        }

        async function saveItem() {
            const formData = collectFormData(currentModalType);
            
            if (!validateFormData(formData, currentModalType)) {
                return;
            }

            try {
                let collection = '';
                let array;
                
                switch (currentModalType) {
                    case 'capital_market':
                        collection = 'capitalMarkets';
                        array = capitalMarkets;
                        break;
                    case 'property':
                        collection = 'properties';
                        array = properties;
                        break;
                    case 'account':
                        collection = 'accounts';
                        array = accounts;
                        break;
                    case 'liability':
                        collection = 'liabilities';
                        array = liabilities;
                        break;
                    case 'income':
                        collection = 'incomes';
                        array = incomes;
                        break;
                    case 'expense':
                        collection = 'expenses';
                        array = expenses;
                        break;
                    case 'budget':
                        collection = 'budgets';
                        array = budgets;
                        break;
                }

                if (editingId) {
                    // Update existing item
                    formData.id = editingId;
                    await FirebaseService.saveData(collection, formData);
                    
                    const index = array.findIndex(item => item.id === editingId);
                    if (index !== -1) {
                        array[index] = formData;
                    }
                    showToast('Item updated successfully!');
                } else {
                    // Create new item
                    const savedItem = await FirebaseService.saveData(collection, formData);
                    array.push(savedItem);
                    showToast('Item added successfully!');
                }

                closeModal();
                renderTabContent();
                updateLastUpdated();

            } catch (error) {
                console.error('Error saving item:', error);
                showToast('Error saving item. Please try again.', 'error');
            }
        }

        function collectFormData(type) {
            const data = {};
            
            switch (type) {
                case 'capital_market':
                    data.name = document.getElementById('capitalMarketName')?.value || '';
                    data.type = document.getElementById('capitalMarketType')?.value || '';
                    data.monthlyInvestment = parseFloat(document.getElementById('capitalMarketMonthlyInvestment')?.value || 0);
                    data.riskLevel = document.getElementById('capitalMarketRiskLevel')?.value || 'medium';
                    data.currency = document.getElementById('capitalMarketCurrency')?.value || 'EUR';
                    
                    if (data.type === 'life_insurance') {
                        data.quantity = 1;
                        data.purchasePrice = parseFloat(document.getElementById('capitalMarketPurchasePrice')?.value || 0);
                        data.currentValue = parseFloat(document.getElementById('capitalMarketCurrentValue')?.value || 0);
                        data.currentPrice = data.currentValue; // For compatibility
                    } else {
                        data.quantity = parseFloat(document.getElementById('capitalMarketQuantity')?.value || 0);
                        data.purchasePrice = parseFloat(document.getElementById('capitalMarketPurchasePrice')?.value || 0);
                        data.currentPrice = parseFloat(document.getElementById('capitalMarketCurrentPrice')?.value || 0);
                    }
                    break;
                    
                case 'property':
                    data.name = document.getElementById('propertyName')?.value || '';
                    data.address = document.getElementById('propertyAddress')?.value || '';
                    data.type = document.getElementById('propertyType')?.value || '';
                    data.purchasePrice = parseFloat(document.getElementById('propertyPurchasePrice')?.value || 0);
                    data.currentValue = parseFloat(document.getElementById('propertyCurrentValue')?.value || 0);
                    data.currency = document.getElementById('propertyCurrency')?.value || 'EUR';
                    if (data.type === 'rental') {
                        data.monthlyRent = parseFloat(document.getElementById('propertyMonthlyRent')?.value || 0);
                    }
                    break;
                    
                case 'account':
                    data.name = document.getElementById('accountName')?.value || '';
                    data.bank = document.getElementById('accountBank')?.value || '';
                    data.type = document.getElementById('accountType')?.value || '';
                    data.balance = parseFloat(document.getElementById('accountBalance')?.value || 0);
                    data.terms = document.getElementById('accountTerms')?.value || '';
                    data.currency = document.getElementById('accountCurrency')?.value || 'EUR';
                    
                    if (data.type === 'savings' || data.type === 'term_deposit') {
                        data.interestRate = parseFloat(document.getElementById('accountInterestRate')?.value || 0);
                    }
                    if (data.type === 'term_deposit') {
                        data.lockupPeriod = parseInt(document.getElementById('accountLockupPeriod')?.value || 0);
                    }
                    break;
                    
                case 'liability':
                    data.name = document.getElementById('liabilityName')?.value || '';
                    data.type = document.getElementById('liabilityType')?.value || '';
                    data.balance = parseFloat(document.getElementById('liabilityBalance')?.value || 0);
                    data.interestRate = parseFloat(document.getElementById('liabilityInterestRate')?.value || 0);
                    data.monthlyPayment = parseFloat(document.getElementById('liabilityMonthlyPayment')?.value || 0);
                    data.currency = document.getElementById('liabilityCurrency')?.value || 'EUR';
                    break;
                    
                case 'income':
                    data.name = document.getElementById('incomeName')?.value || '';
                    data.type = document.getElementById('incomeType')?.value || '';
                    data.employer = document.getElementById('incomeEmployer')?.value || '';
                    data.monthlyGross = parseFloat(document.getElementById('incomeMonthlyGross')?.value || 0);
                    data.taxRate = parseFloat(document.getElementById('incomeTaxRate')?.value || 0);
                    data.currency = document.getElementById('incomeCurrency')?.value || 'EUR';
                    break;
                    
                case 'expense':
                    data.date = document.getElementById('expenseDate')?.value || '';
                    data.description = document.getElementById('expenseDescription')?.value || '';
                    data.category = document.getElementById('expenseCategory')?.value || '';
                    data.amount = parseFloat(document.getElementById('expenseAmount')?.value || 0);
                    data.currency = document.getElementById('expenseCurrency')?.value || 'EUR';
                    break;
                    
                case 'budget':
                    data.category = document.getElementById('budgetCategory')?.value || '';
                    data.amount = parseFloat(document.getElementById('budgetAmount')?.value || 0);
                    data.spent = parseFloat(document.getElementById('budgetSpent')?.value || 0);
                    data.currency = document.getElementById('budgetCurrency')?.value || 'EUR';
                    break;
            }
            
            return data;
        }

        function validateFormData(data, type) {
            // Basic validation - extend as needed
            for (const key in data) {
                if (['monthlyRent', 'terms', 'interestRate', 'lockupPeriod', 'currentValue'].includes(key)) continue; // Optional fields
                if (data[key] === undefined || data[key] === '' || (typeof data[key] === 'number' && isNaN(data[key]))) {
                    showToast(`Please fill in all required fields`, 'error');
                    return false;
                }
            }
            return true;
        }

        async function deleteItem(type, id) {
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }
            
            try {
                let collection = '';
                let array;
                
                switch (type) {
                    case 'capital_market':
                        collection = 'capitalMarkets';
                        array = capitalMarkets;
                        break;
                    case 'property':
                        collection = 'properties';
                        array = properties;
                        break;
                    case 'account':
                        collection = 'accounts';
                        array = accounts;
                        break;
                    case 'liability':
                        collection = 'liabilities';
                        array = liabilities;
                        break;
                    case 'income':
                        collection = 'incomes';
                        array = incomes;
                        break;
                    case 'expense':
                        collection = 'expenses';
                        array = expenses;
                        break;
                    case 'budget':
                        collection = 'budgets';
                        array = budgets;
                        break;
                }

                await FirebaseService.deleteData(collection, id);
                
                // Remove from local array
                const index = array.findIndex(item => item.id === id);
                if (index !== -1) {
                    array.splice(index, 1);
                }
                
                renderTabContent();
                updateLastUpdated();
                showToast('Item deleted successfully!');
                
            } catch (error) {
                console.error('Error deleting item:', error);
                showToast('Error deleting item. Please try again.', 'error');
            }
        }

        // Export functionality
        function exportToExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                // Create summary sheet
                const summaryData = [
                    ['WealthTracker Pro - Financial Summary'],
                    ['Generated on:', new Date().toLocaleDateString()],
                    [''],
                    ['Net Worth Summary'],
                    ['Total Assets', calculateTotalAssets()],
                    ['Total Liabilities', calculateTotalLiabilities()],
                    ['Net Worth', calculateNetWorth()],
                    ['Invested Capital', calculateInvestedCapital()],
                    [''],
                    ['Monthly Cash Flow'],
                    ['Monthly Income', calculateMonthlyIncome()],
                    ['Monthly Expenses', calculateMonthlyExpenses()],
                    ['Net Monthly Cash Flow', calculateMonthlyIncome() - calculateMonthlyExpenses()]
                ];
                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');

                // Capital Markets sheet
                if (capitalMarkets.length > 0) {
                    const capitalMarketsData = [
                        ['Investment', 'Type', 'Quantity', 'Purchase Price', 'Current Price/Value', 'Total Value', 'Monthly Investment', 'Risk Level', 'Gain/Loss', 'Currency'],
                        ...capitalMarkets.map(inv => {
                            let totalValue, gainLoss;
                            if (inv.type === 'life_insurance') {
                                totalValue = inv.currentValue || inv.purchasePrice;
                                gainLoss = totalValue - inv.purchasePrice;
                            } else {
                                totalValue = inv.quantity * inv.currentPrice;
                                gainLoss = totalValue - (inv.quantity * inv.purchasePrice);
                            }
                            
                            return [
                                inv.name,
                                inv.type,
                                inv.quantity,
                                inv.purchasePrice,
                                inv.type === 'life_insurance' ? inv.currentValue : inv.currentPrice,
                                totalValue,
                                inv.monthlyInvestment || 0,
                                inv.riskLevel,
                                gainLoss,
                                inv.currency
                            ];
                        })
                    ];
                    const capitalMarketsSheet = XLSX.utils.aoa_to_sheet(capitalMarketsData);
                    XLSX.utils.book_append_sheet(wb, capitalMarketsSheet, 'Capital Markets');
                }

                // Properties sheet (unchanged)
                if (properties.length > 0) {
                    const propertyData = [
                        ['Property', 'Address', 'Type', 'Purchase Price', 'Current Value', 'Appreciation', 'Monthly Rent', 'Currency'],
                        ...properties.map(prop => [
                            prop.name,
                            prop.address,
                            prop.type,
                            prop.purchasePrice,
                            prop.currentValue,
                            prop.currentValue - prop.purchasePrice,
                            prop.monthlyRent || 0,
                            prop.currency
                        ])
                    ];
                    const propertySheet = XLSX.utils.aoa_to_sheet(propertyData);
                    XLSX.utils.book_append_sheet(wb, propertySheet, 'Real Estate');
                }

                // Enhanced Accounts sheet
                if (accounts.length > 0) {
                    const accountData = [
                        ['Account Name', 'Bank', 'Type', 'Balance', 'Interest Rate', 'Lockup Period', 'Terms', 'Currency'],
                        ...accounts.map(acc => [
                            acc.name,
                            acc.bank,
                            acc.type,
                            acc.balance,
                            acc.interestRate || 0,
                            acc.lockupPeriod || 0,
                            acc.terms || '',
                            acc.currency
                        ])
                    ];
                    const accountSheet = XLSX.utils.aoa_to_sheet(accountData);
                    XLSX.utils.book_append_sheet(wb, accountSheet, 'Accounts');
                }

                // Continue with other sheets as before...
                if (liabilities.length > 0) {
                    const liabilityData = [
                        ['Liability', 'Type', 'Balance', 'Interest Rate', 'Monthly Payment', 'Currency'],
                        ...liabilities.map(lib => [
                            lib.name,
                            lib.type,
                            lib.balance,
                            lib.interestRate,
                            lib.monthlyPayment,
                            lib.currency
                        ])
                    ];
                    const liabilitySheet = XLSX.utils.aoa_to_sheet(liabilityData);
                    XLSX.utils.book_append_sheet(wb, liabilitySheet, 'Liabilities');
                }

                if (incomes.length > 0) {
                    const incomeData = [
                        ['Income Source', 'Type', 'Employer', 'Monthly Gross', 'Tax Rate', 'Monthly Net', 'Annual Net', 'Currency'],
                        ...incomes.map(inc => [
                            inc.name,
                            inc.type,
                            inc.employer,
                            inc.monthlyGross,
                            inc.taxRate,
                            inc.monthlyGross * (1 - inc.taxRate / 100),
                            inc.monthlyGross * 12 * (1 - inc.taxRate / 100),
                            inc.currency
                        ])
                    ];
                    const incomeSheet = XLSX.utils.aoa_to_sheet(incomeData);
                    XLSX.utils.book_append_sheet(wb, incomeSheet, 'Income');
                }

                if (expenses.length > 0) {
                    const expenseData = [
                        ['Date', 'Description', 'Category', 'Amount', 'Currency'],
                        ...expenses.map(exp => [
                            exp.date,
                            exp.description,
                            exp.category,
                            exp.amount,
                            exp.currency
                        ])
                    ];
                    const expenseSheet = XLSX.utils.aoa_to_sheet(expenseData);
                    XLSX.utils.book_append_sheet(wb, expenseSheet, 'Expenses');
                }

                if (budgets.length > 0) {
                    const budgetData = [
                        ['Category', 'Budget Amount', 'Spent Amount', 'Remaining', 'Percentage Used', 'Currency'],
                        ...budgets.map(bud => [
                            bud.category,
                            bud.amount,
                            bud.spent,
                            bud.amount - bud.spent,
                            ((bud.spent / bud.amount) * 100).toFixed(2) + '%',
                            bud.currency
                        ])
                    ];
                    const budgetSheet = XLSX.utils.aoa_to_sheet(budgetData);
                    XLSX.utils.book_append_sheet(wb, budgetSheet, 'Budgets');
                }

                // Save the file
                const fileName = `WealthTracker_Export_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast('Export completed successfully!');
            } catch (error) {
                console.error('Export failed:', error);
                showToast('Export failed. Please try again.', 'error');
            }
        }

        // Global functions for onclick handlers
        window.editItem = editItem;
        window.deleteItem = deleteItem;

        async function editItem(type, id) {
            openModal(type, id);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async function() {
            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            try {
                // Initialize PWA
                PWAService.init();
                
                // Initialize Firebase and load data
                document.addEventListener('DOMContentLoaded', async function() {
    // Show loading overlay
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    try {
        // Initialize PWA
        PWAService.init();
        
        // Initialize UI first
        createIcons();
        updateLanguage();
        updateLastUpdated();

        // Initialize Authentication (this will handle data loading)
        await AuthService.initialize();

        // Hide loading overlay after a delay
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
        }, 1000);

        // Rest of event listeners...
        setupEventListeners();

    } catch (error) {
        console.error('Error initializing app:', error);
        loadingOverlay.innerHTML = `
            <div class="text-center">
                <div class="text-red-600 text-xl mb-4">‚ö†Ô∏è</div>
                <p class="text-gray-600">Error loading app. Please refresh the page.</p>
            </div>
        `;
    }
});

// Separate function for event listeners
function setupEventListeners() {
    // Authentication Event Listeners
    document.getElementById('loginBtn').addEventListener('click', handleLogin);
    document.getElementById('registerBtn').addEventListener('click', handleRegister);
    document.getElementById('googleSignInBtn').addEventListener('click', handleGoogleSignIn);
    document.getElementById('logoutBtn').addEventListener('click', AuthService.signOut);
    
    // Form toggle listeners
    document.getElementById('showRegisterBtn').addEventListener('click', showRegisterForm);
    document.getElementById('showLoginBtn').addEventListener('click', showLoginForm);

    // Language switcher
    document.getElementById('languageSelect').addEventListener('change', function() {
        currentLanguage = this.value;
        updateLanguage();
        if (currentUser) renderTabContent();
    });

    // Currency switcher
    document.getElementById('currencySelect').addEventListener('change', function() {
        currentCurrency = this.value;
        if (currentUser) renderTabContent();
    });

    // Navigation
    document.querySelectorAll('.nav-item').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    // Modal controls
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('cancelModal').addEventListener('click', closeModal);
    document.getElementById('saveModal').addEventListener('click', saveItem);

    // Add Item button logic
    document.getElementById('addItemBtn').addEventListener('click', () => {
        if (!currentUser) {
            showToast('Please login first', 'error');
            return;
        }
        
        switch (activeTab) {
            case 'capital-markets':
                openModal('capital_market');
                break;
            case 'real-estate':
                openModal('property');
                break;
            case 'accounts':
                openModal('account');
                break;
            case 'liabilities':
                openModal('liability');
                break;
            case 'income':
                openModal('income');
                break;
            case 'expenses':
                openModal('expense');
                break;
            case 'budgets':
                openModal('budget');
                break;
            default:
                showToast('Please navigate to a specific section to add items', 'error');
        }
    });

    // Specific add buttons
    const addButtons = [
        { id: 'addCapitalMarketBtn', type: 'capital_market' },
        { id: 'addPropertyBtn', type: 'property' },
        { id: 'addAccountBtn', type: 'account' },
        { id: 'addLiabilityBtn', type: 'liability' },
        { id: 'addIncomeBtn', type: 'income' },
        { id: 'addExpenseBtn', type: 'expense' },
        { id: 'addBudgetBtn', type: 'budget' }
    ];

    addButtons.forEach(btn => {
        const element = document.getElementById(btn.id);
        if (element) {
            element.addEventListener('click', () => {
                if (!currentUser) {
                    showToast('Please login first', 'error');
                    return;
                }
                openModal(btn.type);
            });
        }
    });

    // Export functionality
    document.getElementById('exportBtn').addEventListener('click', () => {
        if (!currentUser) {
            showToast('Please login first', 'error');
            return;
        }
        exportToExcel();
    });

    // Dynamic form field handlers
    document.addEventListener('change', function(e) {
        // Property type change handler
        if (e.target.id === 'propertyType') {
            const rentalSection = document.getElementById('rentalSection');
            if (rentalSection) {
                rentalSection.style.display = e.target.value === 'rental' ? 'block' : 'none';
            }
        }
        
        // Capital market type change handler
        if (e.target.id === 'capitalMarketType') {
            const quantityPriceSection = document.getElementById('quantityPriceSection');
            const currentPriceSection = document.getElementById('currentPriceSection');
            const lifeInsuranceSection = document.getElementById('lifeInsuranceSection');
            
            if (e.target.value === 'life_insurance') {
                if (quantityPriceSection) quantityPriceSection.style.display = 'none';
                if (currentPriceSection) currentPriceSection.style.display = 'none';
                if (lifeInsuranceSection) lifeInsuranceSection.style.display = 'block';
            } else {
                if (quantityPriceSection) quantityPriceSection.style.display = 'grid';
                if (currentPriceSection) currentPriceSection.style.display = 'block';
                if (lifeInsuranceSection) lifeInsuranceSection.style.display = 'none';
            }
        }
        
        // Account type change handler
        if (e.target.id === 'accountType') {
            const interestSection = document.getElementById('interestSection');
            const lockupSection = document.getElementById('lockupSection');
            
            if (e.target.value === 'savings' || e.target.value === 'term_deposit') {
                if (interestSection) interestSection.style.display = 'grid';
            } else {
                if (interestSection) interestSection.style.display = 'none';
            }
            
            if (e.target.value === 'term_deposit') {
                if (lockupSection) lockupSection.style.display = 'block';
            } else {
                if (lockupSection) lockupSection.style.display = 'none';
            }
        }
    });

    // Close modal on background click
    document.getElementById('addModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // Handle Enter key in login forms
    document.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (!loginForm.classList.contains('hidden')) {
                handleLogin();
            } else if (!registerForm.classList.contains('hidden')) {
                handleRegister();
            }
        }
    });
}
                
                // Initialize UI
                createIcons();
                updateLanguage();
                updateLastUpdated();
                
                // Initial render
                setTimeout(() => {
                    renderTabContent();
                    loadingOverlay.style.display = 'none';
                }, 1000);

                // Language switcher
                document.getElementById('languageSelect').addEventListener('change', function() {
                    currentLanguage = this.value;
                    updateLanguage();
                    renderTabContent();
                });

                // Currency switcher
                document.getElementById('currencySelect').addEventListener('change', function() {
                    currentCurrency = this.value;
                    renderTabContent();
                });

                // Navigation
                document.querySelectorAll('.nav-item').forEach(btn => {
                    btn.addEventListener('click', () => switchTab(btn.dataset.tab));
                });

                // Modal controls
                document.getElementById('closeModal').addEventListener('click', closeModal);
                document.getElementById('cancelModal').addEventListener('click', closeModal);
                document.getElementById('saveModal').addEventListener('click', saveItem);

                // Updated Add Item button logic
                document.getElementById('addItemBtn').addEventListener('click', () => {
                    switch (activeTab) {
                        case 'capital-markets':
                            openModal('capital_market');
                            break;
                        case 'real-estate':
                            openModal('property');
                            break;
                        case 'accounts':
                            openModal('account');
                            break;
                        case 'liabilities':
                            openModal('liability');
                            break;
                        case 'income':
                            openModal('income');
                            break;
                        case 'expenses':
                            openModal('expense');
                            break;
                        case 'budgets':
                            openModal('budget');
                            break;
                        default:
                            showToast('Please navigate to a specific section to add items', 'error');
                    }
                });

                // Updated specific add buttons
                const addButtons = [
                    { id: 'addCapitalMarketBtn', type: 'capital_market' },
                    { id: 'addPropertyBtn', type: 'property' },
                    { id: 'addAccountBtn', type: 'account' },
                    { id: 'addLiabilityBtn', type: 'liability' },
                    { id: 'addIncomeBtn', type: 'income' },
                    { id: 'addExpenseBtn', type: 'expense' },
                    { id: 'addBudgetBtn', type: 'budget' }
                ];

                addButtons.forEach(btn => {
                    const element = document.getElementById(btn.id);
                    if (element) {
                        element.addEventListener('click', () => openModal(btn.type));
                    }
                });

                // Export functionality
                document.getElementById('exportBtn').addEventListener('click', exportToExcel);

                // Dynamic form field handlers
                document.addEventListener('change', function(e) {
                    // Property type change handler
                    if (e.target.id === 'propertyType') {
                        const rentalSection = document.getElementById('rentalSection');
                        if (rentalSection) {
                            rentalSection.style.display = e.target.value === 'rental' ? 'block' : 'none';
                        }
                    }
                    
                    // Capital market type change handler
                    if (e.target.id === 'capitalMarketType') {
                        const quantityPriceSection = document.getElementById('quantityPriceSection');
                        const currentPriceSection = document.getElementById('currentPriceSection');
                        const lifeInsuranceSection = document.getElementById('lifeInsuranceSection');
                        
                        if (e.target.value === 'life_insurance') {
                            if (quantityPriceSection) quantityPriceSection.style.display = 'none';
                            if (currentPriceSection) currentPriceSection.style.display = 'none';
                            if (lifeInsuranceSection) lifeInsuranceSection.style.display = 'block';
                        } else {
                            if (quantityPriceSection) quantityPriceSection.style.display = 'grid';
                            if (currentPriceSection) currentPriceSection.style.display = 'block';
                            if (lifeInsuranceSection) lifeInsuranceSection.style.display = 'none';
                        }
                    }
                    
                    // Account type change handler
                    if (e.target.id === 'accountType') {
                        const interestSection = document.getElementById('interestSection');
                        const lockupSection = document.getElementById('lockupSection');
                        
                        if (e.target.value === 'savings' || e.target.value === 'term_deposit') {
                            if (interestSection) interestSection.style.display = 'grid';
                        } else {
                            if (interestSection) interestSection.style.display = 'none';
                        }
                        
                        if (e.target.value === 'term_deposit') {
                            if (lockupSection) lockupSection.style.display = 'block';
                        } else {
                            if (lockupSection) lockupSection.style.display = 'none';
                        }
                    }
                });

                // Close modal on background click
                document.getElementById('addModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal();
                    }
                });

            } catch (error) {
                console.error('Error initializing app:', error);
                loadingOverlay.innerHTML = `
                    <div class="text-center">
                        <div class="text-red-600 text-xl mb-4">‚ö†Ô∏è</div>
                        <p class="text-gray-600">Error loading app. Please refresh the page.</p>
                    </div>
                `;
            }
        });

        // Initialize chart cleanup on page unload
        window.addEventListener('beforeunload', function() {
            Object.values(chartInstances).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
        });
    </script>
</body>
</html>">
                                <span class="text-sm text-gray-500">${translate('purchase_price')}:</span>
                                <span class="text-sm font-medium">${formatCurrency(property.purchasePrice, property.currency)}</span>
                            </div>
                            <div class="flex justify-between
